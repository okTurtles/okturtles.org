<!DOCTYPE html><html><head><title>Coverage</title><meta charset="utf-8"><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style>
</head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov medium">60</span><a href="#src/lib/blockchain.coffee"><span class="dirname">src/lib/</span><span class="basename">blockchain.coffee</span></a></li><li><span class="cov high">95</span><a href="#src/lib/blockchains/icann.coffee"><span class="dirname">src/lib/blockchains/</span><span class="basename">icann.coffee</span></a></li><li><span class="cov medium">61</span><a href="#src/lib/blockchains/keyid.coffee"><span class="dirname">src/lib/blockchains/</span><span class="basename">keyid.coffee</span></a></li><li><span class="cov high">78</span><a href="#src/lib/blockchains/namecoin.coffee"><span class="dirname">src/lib/blockchains/</span><span class="basename">namecoin.coffee</span></a></li><li><span class="cov high">82</span><a href="#src/lib/blockchains/nxt.coffee"><span class="dirname">src/lib/blockchains/</span><span class="basename">nxt.coffee</span></a></li><li><span class="cov high">90</span><a href="#src/lib/cache.coffee"><span class="dirname">src/lib/</span><span class="basename">cache.coffee</span></a></li><li><span class="cov high">80</span><a href="#src/lib/config.coffee"><span class="dirname">src/lib/</span><span class="basename">config.coffee</span></a></li><li><span class="cov medium">65</span><a href="#src/lib/dns.coffee"><span class="dirname">src/lib/</span><span class="basename">dns.coffee</span></a></li><li><span class="cov high">89</span><a href="#src/lib/dnschain.coffee"><span class="dirname">src/lib/</span><span class="basename">dnschain.coffee</span></a></li><li><span class="cov medium">69</span><a href="#src/lib/globals.coffee"><span class="dirname">src/lib/</span><span class="basename">globals.coffee</span></a></li><li><span class="cov high">86</span><a href="#src/lib/http.coffee"><span class="dirname">src/lib/</span><span class="basename">http.coffee</span></a></li><li><span class="cov high">77</span><a href="#src/lib/https.coffee"><span class="dirname">src/lib/</span><span class="basename">https.coffee</span></a></li><li><span class="cov high">76</span><a href="#src/lib/httpsUtils.coffee"><span class="dirname">src/lib/</span><span class="basename">httpsUtils.coffee</span></a></li><li><span class="cov high">89</span><a href="#src/lib/pem.coffee"><span class="dirname">src/lib/</span><span class="basename">pem.coffee</span></a></li><li><span class="cov medium">74</span><a href="#src/lib/resolver-stream.coffee"><span class="dirname">src/lib/</span><span class="basename">resolver-stream.coffee</span></a></li><li><span class="cov high">84</span><a href="#src/lib/stacked-scheduler.coffee"><span class="dirname">src/lib/</span><span class="basename">stacked-scheduler.coffee</span></a></li><a id="logo" href="http://visionmedia.github.io/mocha/">m</a></div><div id="stats" class="high"><div class="percentage">75%</div><div class="sloc">1028</div><div class="hits">780</div><div class="misses">248</div></div><div id="files"><div class="file"><h2 id="src/lib/blockchain.coffee">src/lib/blockchain.coffee</h2><div id="stats" class="medium"><div class="percentage">60%</div><div class="sloc">79</div><div class="hits">48</div><div class="misses">31</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">INSTRUCTIONS:</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    1. Copy this file and rename it to your blockchain's name.</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">       The name you choose will also be your metaTLD (e.g. namecoin.coffee =&gt; namecoin.dns)</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    2. Rename the class (following the same naming convention as shown in</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">       `blockchains/namecoin.coffee`) and `extend BlockchainResolver`</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    3. Uncomment and edit the code as appropriate.</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">       Look at how the other blockchains do it (especially namecoin.coffee)</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    REMEMBER: When in doubt, look at `blockchains/namecoin.coffee` !</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">31</td><td class="hits">24</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">32</td><td class="hits">672</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    # Uncomment this:</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    # BlockchainResolver = require('../blockchain.coffee')(dnschain)</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    # For `dnsHandler:`</td></tr><tr class="hit"><td class="line">38</td><td class="hits">24</td><td class="source">    ResolverStream  = require('./resolver-stream')(dnschain)</td></tr><tr class="hit"><td class="line">39</td><td class="hits">24</td><td class="source">    NAME_RCODE = dns2.consts.NAME_TO_RCODE</td></tr><tr class="hit"><td class="line">40</td><td class="hits">24</td><td class="source">    RCODE_NAME = dns2.consts.RCODE_TO_NAME</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    # This class is partially annotated using flowtate</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    # http://flowtype.org/blog/2015/02/20/Flow-Comments.html</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    # https://github.com/jareware/flotate</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    ### @flow ###</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                             # Uncomment the 'extends' comment below:</td></tr><tr class="hit"><td class="line">48</td><td class="hits">24</td><td class="source">    class BlockchainResolver # extends BlockchainResolver</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        # Do you initialization in here.</td></tr><tr class="hit"><td class="line">50</td><td class="hits">24</td><td class="source">        ### (dnschain: DNSChain): BlockchainResolver ###</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            # Fill these in as appropriate:</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">            @log = gNewLogger 'YourChainName'</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">            @tld = 'chn'            # Your chain's TLD</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">            @name = 'templatechain' # Your chain's name (lowercase, no spaces)</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            # Optionally specify how long Redis should cache entries in seconds</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            # @cacheTTL = 600         # 0 == no cache, override here</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            # Fills this object with `startCheck` and `shutdownCheck` methods</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        # This is the default TTL value for all blockchains.</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        # Override it above in the constructor for your blockchain.</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        cacheTTL: gConf.get 'redis:blockchain:ttl'</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        # Return `this` upon successful load, falsy otherwise</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        # If you return `this`, this chain will be included in the parent</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        # DNSChain instance's `@servers` list, and will have its `start:`</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        # method called.</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        ### : ?(BlockchainResolver | boolean) ###</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        config: -&gt;</td></tr><tr class="hit"><td class="line">73</td><td class="hits">6</td><td class="source">            @log.debug &quot;Loading resolver config&quot;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">6</td><td class="source">            @</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            # Fill this in with code to load your config.</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            # We recommend copying and editing the stuff from namecoin.coffee</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            #</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            # if &quot;loaded successfully&quot;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            #     return this</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            # else</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            #     return false</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        # Connect to your blockchain. Return a Promise</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        ### : Promise ###</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            # Replace this with something useful.</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            # 'cb' is of the form (err, args...) -&gt;</td></tr><tr class="hit"><td class="line">88</td><td class="hits">12</td><td class="source">            @startCheck (cb) =&gt; cb null</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        # Close connection to your blockchain and do any other cleanup. Return a Promise.</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        ### : Promise ###</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        shutdown: -&gt;</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            # Replace this with something useful.</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">            # 'cb' is of the form (err, args...) -&gt;</td></tr><tr class="hit"><td class="line">95</td><td class="hits">24</td><td class="source">            @shutdownCheck (cb) =&gt; cb null</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        # Do not modify the result template itself. Instead, set its .data property</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        # in your resources.key function.See how other blockchains do it.</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        ### : object ###</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        resultTemplate: -&gt;</td></tr><tr class="hit"><td class="line">102</td><td class="hits">13</td><td class="source">            version: '0.0.1'</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            header:</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                datastore: @name</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            data: {} # &lt;== Your `resources.key` function *must* set this to a JSON</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                     #     object that contains the output from your blockchain.</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        standardizers:</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">            # These Functions convert data in the `data` object (see `resultTemplate` above)</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            # into a standard form (primarily for processing by `dnsHandler`s.</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">            # See nxt.coffee for example of how to override.</td></tr><tr class="hit"><td class="line">112</td><td class="hits">6</td><td class="source">            dnsInfo: (data) -&gt; data.value # Value sould conform to Namecoin's d/ spec.</td></tr><tr class="hit"><td class="line">113</td><td class="hits">7</td><td class="source">            ttlInfo: (data) -&gt; 600 # 600 seconds for Namecoin (override if necessary)</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        # Any valid resource for a blockchain should be set here.</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        # All keys of this object must be functions of this form:</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        #   (property: string, operation: string, fmt: string, args: object, cb: function(err: object, result: object)) -&gt;</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        # For more information, see:</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        #   https://github.com/okTurtles/openname-specifications/blob/resolvers/resolvers.md</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        resources:</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">            key: (property, operation, fmt, args, cb) -&gt;</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">                cb new Error &quot;Not Implemented&quot;</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                # Example of what this function should do.</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                # Uncomment and edit:</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                #result = @resultTemplate()</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                # myBlockchain.resolve path, (err, answer) =&gt;</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                #     if err</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                #         cb err</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                #     else</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                #         result.data = JSON.parse answer</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                #         cb null, result</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        dnsHandler: # A dictionary of functions corresponding to traditional DNS.</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">            # You DO NOT need to copy these functions over unless you want to customize</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">            # them for your blockchain. By default, these are designed for Namecoin's d/ spec. </td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">            # Value of `this` is bound to the class instance (i.e. you blockchain).</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">            # TODO: handle all the types specified in the specification!</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">            #       https://wiki.namecoin.info/index.php?title=Domain_Name_Specification#Value_field</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">            #</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            # TODO: handle other info outside of the specification!</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">            #       - GNS support</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            #       - DNSSEC support?</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">            # Functions must be of this function signature</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            ### (object, object, number, object, function): any ###</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">            A: (req, res, qIdx, data, cb) -&gt;</td></tr><tr class="hit"><td class="line">148</td><td class="hits">7</td><td class="source">                q = req.question[qIdx]</td></tr><tr class="hit"><td class="line">149</td><td class="hits">7</td><td class="source">                @log.debug gLineInfo &quot;A handler for #{@name}&quot;, {q:q}</td></tr><tr class="hit"><td class="line">150</td><td class="hits">7</td><td class="source">                info = @standardizers.dnsInfo data</td></tr><tr class="hit"><td class="line">151</td><td class="hits">7</td><td class="source">                ttl = @standardizers.ttlInfo data</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                # According to NMC specification, specifying 'ns'</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                # overrules 'ip' value, so check it here and resolve using</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                # old-style DNS.</td></tr><tr class="hit"><td class="line">156</td><td class="hits">7</td><td class="source">                if info.ns?.length &gt; 0</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                    # 1. Create a stream of nameserver IP addresses out of info.ns</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                    # 2. Send request to each of the servers, separated by `stackedDelay`.</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">                    #    On receiving the first answer from any of them, cancel all other</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">                    #    pending requests and respond to our client.</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                    #</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                    # TODO: handle ns = IPv6 addr!</td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">                    [nsIPs, nsCNAMEs] = [[],[]]</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">165</td><td class="hits">1</td><td class="source">                    for ip in info.ns</td></tr><tr class="hit"><td class="line">166</td><td class="hits">2</td><td class="source">                        (if net.isIP(ip) then nsIPs else nsCNAMEs).push(ip)</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">168</td><td class="hits">1</td><td class="source">                    if @method is gConsts.oldDNS.NO_OLD_DNS_EVER</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                        nsCNAMEs = []</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                    # IMPORTANT! This DNSChain server might have a bi-directional relationship</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                    #            with another local resolver for oldDNS (like PowerDNS). We</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                    #            don't want malicious data in the blockchain to result in</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">                    #            queries being sent back and forth between them ad-infinitum!</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">                    #            Namecoin's specification states that these should only be</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                    #            oldDNS TLDs anyway. Use 'delegate', 'import', or 'map' to</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                    #            refer to other blockchain locations:</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                    #            https://wiki.namecoin.info/index.php?title=Domain_Name_Specification#Value_field</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                    # WARNING!   Because of this issue, it's probably best to not create a</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                    #            bi-directional relationship like this between two resolvers.</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                    #            It's far safer to tell DNSChain to use a different resolver</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                    #            that won't re-ask DNSChain any questions.</td></tr><tr class="hit"><td class="line">183</td><td class="hits">1</td><td class="source">                    nsCNAMEs = _.reject nsCNAMEs, (ns)-&gt;/\.(bit|dns)$/.test ns</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                    # IPs like 127.0.0.1 are checked below against gConf.localhosts array</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">186</td><td class="hits">1</td><td class="source">                    if nsIPs.length == nsCNAMEs.length == 0</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                        return cb NAME_RCODE.REFUSED</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                    # TODO: use these statically instead of creating new instances for each request</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                    #       See: https://github.com/okTurtles/dnschain/issues/11</td></tr><tr class="hit"><td class="line">191</td><td class="hits">1</td><td class="source">                    nsCNAME2IP   = new ResolverStream</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">                        name        : 'nsCNAME2IP' # +'-'+(instanceNum++)</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                        stackedDelay: 100</td></tr><tr class="hit"><td class="line">194</td><td class="hits">1</td><td class="source">                    stackedQuery = new ResolverStream</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                        name        : 'stackedQuery' #+'-'+(instanceNum-1)</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                        stackedDelay: 1000</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                        reqMaker    : (nsIP) =&gt;</td></tr><tr class="hit"><td class="line">198</td><td class="hits">1</td><td class="source">                            dns2.Request</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">                                question: q</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">                                server: address: nsIP</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">202</td><td class="hits">1</td><td class="source">                    nsIPs = gES.merge(gES.readArray(nsIPs), gES.readArray(nsCNAMEs).pipe(nsCNAME2IP))</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">204</td><td class="hits">1</td><td class="source">                    stopRequests = (code) =&gt;</td></tr><tr class="hit"><td class="line">205</td><td class="hits">1</td><td class="source">                        if code</td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">                            @log.warn gLineInfo(&quot;errors on all NS!&quot;), {q:q, code:RCODE_NAME[code]}</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">                        else</td></tr><tr class="hit"><td class="line">208</td><td class="hits">1</td><td class="source">                            @log.debug gLineInfo('ending async requests'), {q:q}</td></tr><tr class="hit"><td class="line">209</td><td class="hits">1</td><td class="source">                        rs.cancelRequests(true) for rs in [nsCNAME2IP, stackedQuery]</td></tr><tr class="hit"><td class="line">210</td><td class="hits">1</td><td class="source">                        cb code</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">212</td><td class="hits">1</td><td class="source">                    nsIPs.on 'data', (nsIP) =&gt;</td></tr><tr class="hit"><td class="line">213</td><td class="hits">2</td><td class="source">                        if _.find(gConf.localhosts, (ip)-&gt;S(nsIP).startsWith ip)</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">                            # avoid the possible infinite-loop on some (perhaps poorly) configured systems</td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">                            @log.warn gLineInfo('dropping query, NMC NS ~= localhost!'), {q:q, nsIP:nsIP, info:info}</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                        else</td></tr><tr class="hit"><td class="line">217</td><td class="hits">2</td><td class="source">                            stackedQuery.write(nsIP)</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">219</td><td class="hits">1</td><td class="source">                    nsCNAME2IP.on 'failed', (err) =&gt;</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">                        @log.warn gLineInfo('nsCNAME2IP error'), {error:err?.message, q:q}</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">                        if nsCNAME2IP.errCount == info.ns.length</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">                            stopRequests err.code ? NAME_RCODE.NOTFOUND</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">224</td><td class="hits">1</td><td class="source">                    stackedQuery.on 'failed', (err) =&gt;</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">                        @log.warn gLineInfo('stackedQuery error'), {error:err?.message, q:q}</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                        if stackedQuery.errCount == info.ns.length</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">                            stopRequests err.code ? NAME_RCODE.SERVFAIL</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">229</td><td class="hits">1</td><td class="source">                    stackedQuery.on 'answers', (answers) =&gt;</td></tr><tr class="hit"><td class="line">230</td><td class="hits">1</td><td class="source">                        @log.debug gLineInfo('stackedQuery answers'), {answers:answers}</td></tr><tr class="hit"><td class="line">231</td><td class="hits">1</td><td class="source">                        res.answer.push answers...</td></tr><tr class="hit"><td class="line">232</td><td class="hits">1</td><td class="source">                        stopRequests()</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">234</td><td class="hits">6</td><td class="source">                else if info.ip</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">                    # we have its IP! send reply to client</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">                    # TODO: handle more info! send the rest of the</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">                    #       stuff in 'info', and all the IPs!</td></tr><tr class="hit"><td class="line">238</td><td class="hits">6</td><td class="source">                    info.ip = [info.ip] if typeof info.ip is 'string'</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">                    # info.ip.forEach (a)-&gt; res.answer.push gIP2type(q.name, ttl)(a)</td></tr><tr class="hit"><td class="line">240</td><td class="hits">6</td><td class="source">                    res.answer.push (info.ip.map gIP2type(q.name, ttl))...</td></tr><tr class="hit"><td class="line">241</td><td class="hits">6</td><td class="source">                    cb()</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                    @log.warn gLineInfo('no useful data from nmc_show'), {q:q}</td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="source">                    cb NAME_RCODE.NOTFOUND</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">            # /end 'A'</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">            # TODO: implement this!</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            AAAA: (req, res, qIdx, data, cb) -&gt;</td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo &quot;AAAA handler for #{@name}&quot;</td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="source">                cb NAME_RCODE.NOTIMP</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">            TLSA: (req, res, qIdx, data, cb) -&gt;</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                q = req.question[qIdx]</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo &quot;TLSA handler for #{@name}&quot;, {q:q}</td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">                ttl = @standardizers.ttlInfo data</td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="source">                len = res.answer.length</td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">                if info = @standardizers.dnsInfo data</td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">                    res.answer.push gTls2tlsa(info.tls, ttl, q.name)...</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                # check if any records were added</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">                if res.answer.length - len is 0</td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">                    @log.warn gLineInfo('no TLSA found'), {q:q, data:data}</td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">                    cb NAME_RCODE.NOTFOUND</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">                    cb()</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">            ANY: -&gt;</td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo &quot;ANY handler for #{@name}&quot;</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                # TODO: loop through dnsInfo and call approrpriate handlers</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                # TODO: enable EDNS reply</td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">                @dnsHandler.A.apply @, [].slice.call arguments</td></tr></tbody></table></div><div class="file"><h2 id="src/lib/blockchains/icann.coffee">src/lib/blockchains/icann.coffee</h2><div id="stats" class="high"><div class="percentage">95%</div><div class="sloc">23</div><div class="hits">22</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">Packet = require('native-dns-packet')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">18</td><td class="hits">6</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">19</td><td class="hits">168</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">6</td><td class="source">    BlockchainResolver = require('../blockchain.coffee')(dnschain)</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">6</td><td class="source">    QTYPE_NAME = dns2.consts.QTYPE_TO_NAME</td></tr><tr class="hit"><td class="line">24</td><td class="hits">6</td><td class="source">    NAME_QTYPE = dns2.consts.NAME_TO_QTYPE</td></tr><tr class="hit"><td class="line">25</td><td class="hits">6</td><td class="source">    NAME_RCODE = dns2.consts.NAME_TO_RCODE</td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">    RCODE_NAME = dns2.consts.RCODE_TO_NAME</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">6</td><td class="source">    class IcannResolver extends BlockchainResolver</td></tr><tr class="hit"><td class="line">29</td><td class="hits">6</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">30</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'ICANN'</td></tr><tr class="hit"><td class="line">31</td><td class="hits">6</td><td class="source">            @name = 'icann'</td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        resources:</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            key: (property, operation, fmt, args, cb) -&gt;</td></tr><tr class="hit"><td class="line">36</td><td class="hits">3</td><td class="source">                req = new Packet()</td></tr><tr class="hit"><td class="line">37</td><td class="hits">3</td><td class="source">                result = @resultTemplate()</td></tr><tr class="hit"><td class="line">38</td><td class="hits">3</td><td class="source">                @log.debug gLineInfo(&quot;#{@name} resolve&quot;), {property:property, args:args}</td></tr><tr class="hit"><td class="line">39</td><td class="hits">3</td><td class="source">                req.question.push dns2.Question {name: property, type: args.type if args?.type? and _.has NAME_QTYPE,args.type}</td></tr><tr class="hit"><td class="line">40</td><td class="hits">3</td><td class="source">                @dnschain.dns.oldDNSLookup req, (code, packet) =&gt;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">3</td><td class="source">                    if code</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                        cb {code:code, name:RCODE_NAME[code]}</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="hit"><td class="line">44</td><td class="hits">3</td><td class="source">                        result.data = packet</td></tr><tr class="hit"><td class="line">45</td><td class="hits">3</td><td class="source">                        cb null, result</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/blockchains/keyid.coffee">src/lib/blockchains/keyid.coffee</h2><div id="stats" class="medium"><div class="percentage">61%</div><div class="sloc">42</div><div class="hits">26</div><div class="misses">16</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">16</td><td class="hits">6</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">17</td><td class="hits">168</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">6</td><td class="source">    BlockchainResolver = require('../blockchain.coffee')(dnschain)</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">6</td><td class="source">    class KeyidResolver extends BlockchainResolver</td></tr><tr class="hit"><td class="line">22</td><td class="hits">6</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">23</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'KeyID'</td></tr><tr class="hit"><td class="line">24</td><td class="hits">6</td><td class="source">            @tld = 'p2p'</td></tr><tr class="hit"><td class="line">25</td><td class="hits">6</td><td class="source">            @name = 'keyid'</td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        config: -&gt;</td></tr><tr class="hit"><td class="line">29</td><td class="hits">6</td><td class="source">            @log.debug &quot;Loading #{@name} resolver&quot;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">6</td><td class="source">            return unless gConf.add @name, _.map(_.filter([</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                [process.env.APPDATA, 'KeyID', 'config.json'],</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                [process.env.HOME, '.KeyID', 'config.json'],</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">                [process.env.HOME, 'Library', 'Application Support', 'KeyID', 'config.json']]</td></tr><tr class="hit"><td class="line">35</td><td class="hits">18</td><td class="source">            , (x) -&gt; !!x[0])</td></tr><tr class="hit"><td class="line">36</td><td class="hits">12</td><td class="source">            , (x) -&gt; path.join x...)</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">6</td><td class="source">            @params = _.transform [&quot;httpd_endpoint&quot;, &quot;rpc_user&quot;, &quot;rpc_password&quot;], (o,v) =&gt;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">18</td><td class="source">                o[v] = gConf.chains[@name].get 'rpc:'+v</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            , {}</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">6</td><td class="source">            unless _(@params).values().every()</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                missing = _.transform @params, ((o,v,k)-&gt;if !v then o.push 'rpc:'+k), []</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                @log.info &quot;Disabled. Missing params:&quot;, missing</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                return</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">6</td><td class="source">            [@params.host, @params.port] = @params.httpd_endpoint.split ':'</td></tr><tr class="hit"><td class="line">48</td><td class="hits">6</td><td class="source">            @params.port = parseInt @params.port</td></tr><tr class="hit"><td class="line">49</td><td class="hits">6</td><td class="source">            gConf.chains[@name].set 'host', @params.host</td></tr><tr class="hit"><td class="line">50</td><td class="hits">6</td><td class="source">            @</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr class="hit"><td class="line">53</td><td class="hits">6</td><td class="source">            @startCheck (success) =&gt;</td></tr><tr class="hit"><td class="line">54</td><td class="hits">6</td><td class="source">                params = _.at @params, [&quot;port&quot;, &quot;host&quot;, &quot;rpc_user&quot;, &quot;rpc_password&quot;]</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                # TODO: $create doesn't actually connect. you need to open a raw socket</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                #       or an http socket and see if that works before declaring it works</td></tr><tr class="hit"><td class="line">57</td><td class="hits">6</td><td class="source">                @peer = rpc.Client.$create(params...) or gErr &quot;rpc create&quot;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">6</td><td class="source">                @log.info &quot;rpc to bitshares_client on: %s:%d/rpc&quot;, @params.host, @params.port</td></tr><tr class="hit"><td class="line">59</td><td class="hits">6</td><td class="source">                success()</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        resources:</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">            key: (property, operation, fmt, args, cb) -&gt;</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">                result = @resultTemplate()</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo(&quot;#{@name} resolve&quot;), {property:property}</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">                @peer.call 'dotp2p_show', [property], property:'/rpc', (err, ans) -&gt;</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                    return cb(err) if err</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">                    if _.isString ans</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">                        try</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                            result.data = JSON.parse ans</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                        catch e</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                            @log.error glineInfo(e.message)</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                            return cb e</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">                    else if not _.isObject ans</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                        @log.warn gLineInfo('type not string or object!'), {json: ans, type: typeof(ans)}</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">                        result.data = {}</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                    cb null, result</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/blockchains/namecoin.coffee">src/lib/blockchains/namecoin.coffee</h2><div id="stats" class="high"><div class="percentage">78%</div><div class="sloc">52</div><div class="hits">41</div><div class="misses">11</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">16</td><td class="hits">6</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">17</td><td class="hits">168</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">6</td><td class="source">    BlockchainResolver = require('../blockchain.coffee')(dnschain)</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    # https://wiki.namecoin.info/index.php?title=Domain_Name_Specification#Regular_Expression</td></tr><tr class="hit"><td class="line">22</td><td class="hits">6</td><td class="source">    VALID_NMC_DOMAINS = /^[a-z]([a-z0-9-]{0,62}[a-z0-9])?$/</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">6</td><td class="source">    class NamecoinResolver extends BlockchainResolver</td></tr><tr class="hit"><td class="line">25</td><td class="hits">6</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'NMC'</td></tr><tr class="hit"><td class="line">27</td><td class="hits">6</td><td class="source">            @name = 'namecoin'</td></tr><tr class="hit"><td class="line">28</td><td class="hits">6</td><td class="source">            @tld = 'bit'</td></tr><tr class="hit"><td class="line">29</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        config: -&gt;</td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">            @log.debug &quot;Loading #{@name} resolver&quot;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">6</td><td class="source">            return unless gConf.add @name, _.map(_.filter([</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                [process.env.APPDATA, 'Namecoin', 'namecoin.conf']</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                [process.env.HOME, '.namecoin', 'namecoin.conf']</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                [process.env.HOME, 'Library', 'Application Support', 'Namecoin', 'namecoin.conf']</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                ['/etc/namecoin/namecoin.conf']]</td></tr><tr class="hit"><td class="line">39</td><td class="hits">24</td><td class="source">            , (x) -&gt; !!x[0])</td></tr><tr class="hit"><td class="line">40</td><td class="hits">18</td><td class="source">            , (x) -&gt; path.join x...), 'INI'</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">6</td><td class="source">            @params = _.transform [&quot;port&quot;, &quot;connect&quot;, &quot;user&quot;, &quot;password&quot;], (o,v) =&gt;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">24</td><td class="source">                o[v] = gConf.chains[@name].get 'rpc'+v</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            , {}</td></tr><tr class="hit"><td class="line">45</td><td class="hits">6</td><td class="source">            @params.connect ?= &quot;127.0.0.1&quot;</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">6</td><td class="source">            unless _(@params).values().every()</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                missing = _.transform @params, ((o,v,k)-&gt;if !v then o.push 'rpc'+k), []</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                @log.info &quot;Disabled. Missing params:&quot;, missing</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                return</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">6</td><td class="source">            gConf.chains[@name].set 'host', @params.connect</td></tr><tr class="hit"><td class="line">53</td><td class="hits">6</td><td class="source">            @</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">6</td><td class="source">            @startCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">57</td><td class="hits">6</td><td class="source">                params = _.at @params, [&quot;port&quot;, &quot;connect&quot;, &quot;user&quot;, &quot;password&quot;]</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                # TODO: $create doesn't actually connect. you need to open a raw socket</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                #       or an http socket and see if that works before declaring it works</td></tr><tr class="hit"><td class="line">60</td><td class="hits">6</td><td class="source">                @peer = rpc.Client.$create(params...) or gErr &quot;rpc create&quot;</td></tr><tr class="hit"><td class="line">61</td><td class="hits">6</td><td class="source">                @log.info &quot;rpc to namecoind on: %s:%d&quot;, @params.connect, @params.port</td></tr><tr class="hit"><td class="line">62</td><td class="hits">6</td><td class="source">                cb null</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        resources:</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            key: (property, operation, fmt, args, cb) -&gt;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">8</td><td class="source">                if not operation?</td></tr><tr class="hit"><td class="line">67</td><td class="hits">8</td><td class="source">                    result = @resultTemplate()</td></tr><tr class="hit"><td class="line">68</td><td class="hits">8</td><td class="source">                    if S(property).endsWith(&quot;.#{@tld}&quot;) # namecoinize Domain</td></tr><tr class="hit"><td class="line">69</td><td class="hits">5</td><td class="source">                        property = S(property).chompRight(&quot;.#{@tld}&quot;).s</td></tr><tr class="hit"><td class="line">70</td><td class="hits">5</td><td class="source">                        if (dotIdx = property.lastIndexOf('.')) != -1</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                            property = property.slice(dotIdx+1) #rm subdomain</td></tr><tr class="hit"><td class="line">72</td><td class="hits">5</td><td class="source">                        if not VALID_NMC_DOMAINS.test property</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">                            err = new Error &quot;Invalid Domain: #{property}&quot;</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                            err.httpCode = 400</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">                            return cb(err)</td></tr><tr class="hit"><td class="line">76</td><td class="hits">5</td><td class="source">                        property = 'd/' + property</td></tr><tr class="hit"><td class="line">77</td><td class="hits">8</td><td class="source">                    @log.debug gLineInfo(&quot;#{@name} resolve&quot;), {property:property}</td></tr><tr class="hit"><td class="line">78</td><td class="hits">8</td><td class="source">                    @peer.call 'name_show', [property], (err, ans) =&gt;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">8</td><td class="source">                        if err</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">                            @log.error gLineInfo('name_show failed'), {property:property, errMsg:err.message}</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">                            cb err</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                        else</td></tr><tr class="hit"><td class="line">83</td><td class="hits">8</td><td class="source">                            try</td></tr><tr class="hit"><td class="line">84</td><td class="hits">8</td><td class="source">                                ans.value = JSON.parse ans.value</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                            catch e</td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">                                @log.debug gLineInfo('bad JSON'), {value:ans.value, errMsg:e.message}</td></tr><tr class="hit"><td class="line">87</td><td class="hits">8</td><td class="source">                            result.data = ans</td></tr><tr class="hit"><td class="line">88</td><td class="hits">8</td><td class="source">                            cb null, result</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                    @log.debug gLineInfo &quot;unsupported op #{operation} for prop: #{property}&quot;</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">                    cb new Error &quot;Not Implemented&quot;</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/blockchains/nxt.coffee">src/lib/blockchains/nxt.coffee</h2><div id="stats" class="high"><div class="percentage">82%</div><div class="sloc">47</div><div class="hits">39</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">request = require 'superagent'</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">18</td><td class="hits">6</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">19</td><td class="hits">168</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">6</td><td class="source">    BlockchainResolver = require('../blockchain.coffee')(dnschain)</td></tr><tr class="hit"><td class="line">22</td><td class="hits">6</td><td class="source">    ResolverStream  = require('../resolver-stream')(dnschain)</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">6</td><td class="source">    getAsync = Promise.promisify request.get</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">    QTYPE_NAME = dns2.consts.QTYPE_TO_NAME</td></tr><tr class="hit"><td class="line">27</td><td class="hits">6</td><td class="source">    NAME_QTYPE = dns2.consts.NAME_TO_QTYPE</td></tr><tr class="hit"><td class="line">28</td><td class="hits">6</td><td class="source">    NAME_RCODE = dns2.consts.NAME_TO_RCODE</td></tr><tr class="hit"><td class="line">29</td><td class="hits">6</td><td class="source">    RCODE_NAME = dns2.consts.RCODE_TO_NAME</td></tr><tr class="hit"><td class="line">30</td><td class="hits">6</td><td class="source">    BLOCKS2SEC = 60</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">    class NxtResolver extends BlockchainResolver</td></tr><tr class="hit"><td class="line">33</td><td class="hits">6</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">34</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'NXT'</td></tr><tr class="hit"><td class="line">35</td><td class="hits">6</td><td class="source">            @name = 'nxt'</td></tr><tr class="hit"><td class="line">36</td><td class="hits">6</td><td class="source">            @tld = 'nxt'</td></tr><tr class="hit"><td class="line">37</td><td class="hits">6</td><td class="source">            @standardizers.dnsInfo = (data) -&gt; data.aliasURI</td></tr><tr class="hit"><td class="line">38</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        config: -&gt;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">6</td><td class="source">            @log.debug &quot;Loading #{@name} resolver&quot;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">6</td><td class="source">            @params = _.transform [&quot;port&quot;, &quot;connect&quot;], (o,v) =&gt;</td></tr><tr class="hit"><td class="line">44</td><td class="hits">12</td><td class="source">                o[v] = gConf.get 'nxt:'+v</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            , {}</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">6</td><td class="source">            unless _(@params).values().every()</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                missing = _.transform @params, ((o,v,k)-&gt;if !v then o.push 'nxt:'+k), []</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                @log.info &quot;Disabled. Missing params:&quot;, missing</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                return</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">6</td><td class="source">            @peer = &quot;http://#{@params.connect}:#{@params.port}/nxt?requestType=getAlias&amp;aliasName=&quot;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">6</td><td class="source">            @log.info &quot;Nxt API on:&quot;, @params</td></tr><tr class="hit"><td class="line">55</td><td class="hits">6</td><td class="source">            @</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        resources:</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            key: (property, operation, fmt, args, cb) -&gt;</td></tr><tr class="hit"><td class="line">59</td><td class="hits">2</td><td class="source">                result = @resultTemplate()</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">2</td><td class="source">                if S(property).endsWith(&quot;.#{@tld}&quot;)</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">                    property = S(property).chompRight(&quot;.#{@tld}&quot;).s</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">                    if (dotIdx = property.lastIndexOf('.')) != -1</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">                        property = property.slice(dotIdx+1) #rm subdomain</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">2</td><td class="source">                @log.debug gLineInfo(&quot;#{@name} resolve&quot;), {property:property}</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">68</td><td class="hits">2</td><td class="source">                getAsync(@peer + encodeURIComponent(property)).then (res) =&gt;</td></tr><tr class="hit"><td class="line">69</td><td class="hits">2</td><td class="source">                    try</td></tr><tr class="hit"><td class="line">70</td><td class="hits">2</td><td class="source">                        json = JSON.parse res.text</td></tr><tr class="hit"><td class="line">71</td><td class="hits">2</td><td class="source">                        if json.aliasURI?</td></tr><tr class="hit"><td class="line">72</td><td class="hits">2</td><td class="source">                            try json.aliasURI = JSON.parse json.aliasURI</td></tr><tr class="hit"><td class="line">73</td><td class="hits">2</td><td class="source">                        result.data = json</td></tr><tr class="hit"><td class="line">74</td><td class="hits">2</td><td class="source">                        @log.debug gLineInfo('resolved OK!'), {result:result}</td></tr><tr class="hit"><td class="line">75</td><td class="hits">2</td><td class="source">                        cb null, result</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                    catch e</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">                        @log.warn gLineInfo('server did not respond with valid json!'), {err:e.message, url:res.request.url, response:res.text}</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">                        cb e</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                .catch (e) =&gt;</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">                    @log.error gLineInfo('error contacting NXT server!'), {err:e.message}</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">                    cb e</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/cache.coffee">src/lib/cache.coffee</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">61</div><div class="hits">55</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">if process.env.TEST_DNSCHAIN and not process.env.TEST_REAL_REDIS</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    redis = require 'fakeredis'</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">else</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    redis = require 'redis'</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">22</td><td class="hits">28</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    class ResolverCache</td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'Redis'</td></tr><tr class="hit"><td class="line">27</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr class="hit"><td class="line">30</td><td class="hits">6</td><td class="source">            @startCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">31</td><td class="hits">6</td><td class="source">                @blockchainEnabled = gConf.get 'redis:blockchain:enabled'</td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">                @oldDNSEnabled = gConf.get 'redis:oldDNS:enabled'</td></tr><tr class="hit"><td class="line">33</td><td class="hits">6</td><td class="source">                @oldDNSTTL = gConf.get 'redis:oldDNS:ttl'</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">6</td><td class="source">                if !@blockchainEnabled and !@oldDNSEnabled</td></tr><tr class="hit"><td class="line">36</td><td class="hits">5</td><td class="source">                    @log.info &quot;cache not enabled&quot;.bold.yellow</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                else</td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">                    @log.info &quot;cache is enabled&quot;.bold</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">                    [host,port] = gConf.get('redis:socket').split(':')</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">                    @cache =</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                        if port?</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">                            if isNaN(portNum = parseInt port)</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                                gErr &quot;Redis port is NaN: #{port}&quot;</td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">                            redis.createClient portNum, host</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                        else</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">                            redis.createClient host</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">                    @cache.on 'error', (err) =&gt;</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                        @log.error &quot;cache errored: #{err.message}&quot;, err</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                        @shutdown()</td></tr><tr class="hit"><td class="line">50</td><td class="hits">6</td><td class="source">                cb()</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        shutdown: -&gt;</td></tr><tr class="hit"><td class="line">53</td><td class="hits">6</td><td class="source">            @shutdownCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">54</td><td class="hits">6</td><td class="source">                @cache?.end()</td></tr><tr class="hit"><td class="line">55</td><td class="hits">6</td><td class="source">                cb()</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        get: (key, valueRetriever, valueDoer) -&gt;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">50</td><td class="source">            @cache.get key, (err, result) =&gt;</td></tr><tr class="hit"><td class="line">59</td><td class="hits">50</td><td class="source">                if err</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                    @log.error gLineInfo('caching error'), {err: err}</td></tr><tr class="hit"><td class="line">61</td><td class="hits">50</td><td class="source">                if result?</td></tr><tr class="hit"><td class="line">62</td><td class="hits">25</td><td class="source">                    @log.debug gLineInfo('resolved from cache'), {key: key}</td></tr><tr class="hit"><td class="line">63</td><td class="hits">25</td><td class="source">                    valueDoer null, key, JSON.parse result</td></tr><tr class="hit"><td class="line">64</td><td class="hits">25</td><td class="source">                    return</td></tr><tr class="hit"><td class="line">65</td><td class="hits">25</td><td class="source">                valueRetriever key, (err2, ttl, value) =&gt;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">25</td><td class="source">                    @cache.setex(key, ttl, JSON.stringify value) if not err2</td></tr><tr class="hit"><td class="line">67</td><td class="hits">25</td><td class="source">                    valueDoer err, key, value</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        resolveResource: (datastore, requestFn, serialization, cb) -&gt;</td></tr><tr class="hit"><td class="line">70</td><td class="hits">14</td><td class="source">            if @blockchainEnabled and datastore.cacheTTL?</td></tr><tr class="hit"><td class="line">71</td><td class="hits">2</td><td class="source">                retriever = (key, callback) =&gt;</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">                    requestFn (err, result) =&gt;</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">                        callback err, datastore.cacheTTL, result</td></tr><tr class="hit"><td class="line">74</td><td class="hits">2</td><td class="source">                doer = (err, key, result) =&gt;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">2</td><td class="source">                    cb err, result</td></tr><tr class="hit"><td class="line">76</td><td class="hits">2</td><td class="source">                @get serialization, retriever, doer</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            else</td></tr><tr class="hit"><td class="line">78</td><td class="hits">12</td><td class="source">                requestFn cb</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        resolveOldDNS: (req, cb) -&gt;</td></tr><tr class="hit"><td class="line">81</td><td class="hits">104</td><td class="source">            if @oldDNSEnabled</td></tr><tr class="hit"><td class="line">82</td><td class="hits">48</td><td class="source">                q = req.question[0]</td></tr><tr class="hit"><td class="line">83</td><td class="hits">48</td><td class="source">                retriever = (key, callback) =&gt;</td></tr><tr class="hit"><td class="line">84</td><td class="hits">24</td><td class="source">                    f = (err, result) =&gt;</td></tr><tr class="hit"><td class="line">85</td><td class="hits">24</td><td class="source">                        ttl =</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                            if result.answer[0]?.ttl?</td></tr><tr class="hit"><td class="line">87</td><td class="hits">23</td><td class="source">                                Math.min result.answer[0].ttl, @oldDNSTTL</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                            else</td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">                                @oldDNSTTL</td></tr><tr class="hit"><td class="line">90</td><td class="hits">24</td><td class="source">                        callback err, ttl, result</td></tr><tr class="hit"><td class="line">91</td><td class="hits">24</td><td class="source">                    @dnschain.dns.oldDNSLookup req, f</td></tr><tr class="hit"><td class="line">92</td><td class="hits">48</td><td class="source">                doer = (err, key, result) =&gt;</td></tr><tr class="hit"><td class="line">93</td><td class="hits">48</td><td class="source">                    cb err, result</td></tr><tr class="hit"><td class="line">94</td><td class="hits">48</td><td class="source">                @get &quot;oldDNS:#{q.name}:#{q.type}&quot;, retriever, doer</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">            else</td></tr><tr class="hit"><td class="line">96</td><td class="hits">56</td><td class="source">                @dnschain.dns.oldDNSLookup req, cb</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/config.coffee">src/lib/config.coffee</h2><div id="stats" class="high"><div class="percentage">80%</div><div class="sloc">55</div><div class="hits">44</div><div class="misses">11</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">All configuration options can be overwritten using command line args</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">and/or environment variables.</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">Below you will see the available options and their defaults.</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">- The top-level options map to sections in the config file.</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">  I.e. `dns` and `log` designate the sections `[dns]` and `[log]`</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">- All non top-level options are respresented via dot notation.</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  I.e. to set the `oldDNS` `address`, you'd do:</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    [dns]</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    oldDNS.address = 8.8.4.4</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">- For each blockchain, you can specify its configuration file</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  by specifying the blockchain name as a section, and then</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">  setting the config variable.</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">  Example:</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    [namecoin]</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    config = /home/namecoin/.namecoin/namecoin.conf</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">See also:</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">&lt;https://github.com/okTurtles/dnschain/blob/master/docs/How-do-I-run-my-own.md#Configuration&gt;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">nconf = require 'nconf'</td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">props = require 'properties'</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">fs = require 'fs'</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">tty = require 'tty'</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">48</td><td class="hits">26</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    # TODO: add path to our private key for signing answers</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">    amRoot = process.getuid() is 0</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    # =================================================</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    # BEGIN DNSCHAIN CONFIGURATION OPTIONS AND DEFAULTS</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    # =================================================</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">    defaults = {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        log:</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">            level: if process.env.DNS_EXAMPLE then 'debug' else 'info'</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            colors: true</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            pretty: tty.isatty process.stdout</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            timestamp: tty.isatty process.stdout</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        dns:</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">            port: if amRoot then 53 else 5333</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            host: '0.0.0.0' # what we bind to</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            externalIP: gExternalIP() # Advertised IP for .dns metaTLD (ex: namecoin.dns)</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            oldDNSMethod: 'NATIVE_DNS' # see 'globals.coffee' for possible values</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            oldDNS:</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                address: '8.8.8.8' # Google (we recommend running PowerDNS yourself and sending it there)</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                port: 53</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                type: 'udp'</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        http:</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">            port: if amRoot then 80 else 8088       # Standard HTTP port</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">            tlsPort: if amRoot then 443 else 4443   # Standard HTTPS port</td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">            tlsKey: &quot;#{process.env.HOME}/.dnschain/key.pem&quot;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">            tlsCert: &quot;#{process.env.HOME}/.dnschain/cert.pem&quot;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            internalTLSPort: 2500   # Not accessible from the internet, used internally only</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            internalAdminPort: 3000 # Not accessible from the internet, used internally only</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            host: '0.0.0.0' # what we bind to. 0.0.0.0 for the whole internet</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        redis:</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            socket: '127.0.0.1:6379' # or UNIX domain socket path</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            oldDNS:</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                enabled: false</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                ttl: 600 # Maximum time to keep DNS records in cache, regardless of TTL</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            blockchain:</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                enabled: false</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                ttl: 600</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        unblock: # The options in this section are only for when Unblock is enabled.</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            enabled: false</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            acceptApiCallsTo: [&quot;localhost&quot;] # Add your public facing domain here if you want to accept calls to the RESTful API when Unblock is enabled.</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            routeDomains: { # If traffic coming in on the tlsPort needs to be redirected to another application on the server then add it here</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                # Example: &quot;mywebsite.com&quot; : 9000  # This tells the server to send traffic meant to &quot;mywebsite.com&quot; to port 9000. It'll still be encrypted when it reaches port 9000</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        # WARNING: Do not change these settings unless you know exactly what you're doing.</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        # Read the source code, read the Bottleneck docs,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        # make sure you understand how it might make your server complicit in DNS Amplification Attacks and your server might be taken down as a result.</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        rateLimiting:</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            dns:</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                maxConcurrent: 1</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                minTime: 200</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                highWater: 2</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                strategy: Bottleneck.strategy.BLOCK</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                penalty: 7000</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            http:</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                maxConcurrent: 2</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                minTime: 150</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                highWater: 10</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                strategy: Bottleneck.strategy.OVERFLOW</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            https:</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                maxConcurrent: 2</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                minTime: 150</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                highWater: 10</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                strategy: Bottleneck.strategy.OVERFLOW</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    # ===============================================</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    # END DNSCHAIN CONFIGURATION OPTIONS AND DEFAULTS</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">    # ===============================================</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">1</td><td class="source">    fileFormatOpts =</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        comments: ['#', ';']</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        sections: true</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        namespaces: true</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">125</td><td class="hits">1</td><td class="source">    props.parse = _.partialRight props.parse, fileFormatOpts</td></tr><tr class="hit"><td class="line">126</td><td class="hits">1</td><td class="source">    props.stringify = _.partialRight props.stringify, fileFormatOpts</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">128</td><td class="hits">1</td><td class="source">    confTypes =</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">        INI: props</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">        JSON: JSON</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    # load our config</td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">    nconf.argv().env('__')</td></tr><tr class="hit"><td class="line">134</td><td class="hits">1</td><td class="source">    dnscConfLocs = [</td></tr><tr class="hit"><td class="line">135</td><td class="hits">1</td><td class="source">        &quot;#{process.env.HOME}/.dnschain/dnschain.conf&quot;,  # the default</td></tr><tr class="hit"><td class="line">136</td><td class="hits">1</td><td class="source">        &quot;#{process.env.HOME}/.dnschain.conf&quot;,</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">        &quot;/etc/dnschain/dnschain.conf&quot;</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    ]</td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">    dnscConf = _.find dnscConfLocs, (x) -&gt; fs.existsSync x</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">1</td><td class="source">    if process.env.HOME and not fs.existsSync &quot;#{process.env.HOME}/.dnschain&quot;</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">        # create this folder on UNIX based systems so that https.coffee</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        # can autogen the private/public key if they don't exist</td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="source">        fs.mkdirSync &quot;#{process.env.HOME}/.dnschain&quot;, 0o710</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    # we can't access `dnschain.globals.gLogger` here because it hasn't</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    # been defined yet unfortunately.</td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">    if dnscConf</td></tr><tr class="hit"><td class="line">149</td><td class="hits">1</td><td class="source">        console.info &quot;[INFO] Loading DNSChain config from: #{dnscConf}&quot;</td></tr><tr class="hit"><td class="line">150</td><td class="hits">1</td><td class="source">        nconf.file 'user', {file: dnscConf, format: props}</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    else</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">        console.warn &quot;[WARN] No DNSChain configuration file found. Using defaults!&quot;.bold.yellow</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">        nconf.file 'user', {file: dnscConfLocs[0], format: props}</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">155</td><td class="hits">1</td><td class="source">    config =</td></tr><tr class="hit"><td class="line">156</td><td class="hits">639</td><td class="source">        get: (key, store=&quot;dnschain&quot;) -&gt; config.chains[store].get key</td></tr><tr class="hit"><td class="line">157</td><td class="hits">5</td><td class="source">        set: (key, value, store=&quot;dnschain&quot;) -&gt; config.chains[store].set key, value</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        chains:</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">            dnschain: nconf.defaults defaults</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        add: (name, paths, type) -&gt;</td></tr><tr class="hit"><td class="line">161</td><td class="hits">12</td><td class="source">            log = dnschain.globals.gLogger</td></tr><tr class="hit"><td class="line">162</td><td class="hits">12</td><td class="source">            gLineInfo = dnschain.globals.gLineInfo</td></tr><tr class="hit"><td class="line">163</td><td class="hits">12</td><td class="source">            if config.chains[name]?</td></tr><tr class="hit"><td class="line">164</td><td class="hits">10</td><td class="source">                log.warn gLineInfo &quot;Not overwriting existing #{name} configuration&quot;</td></tr><tr class="hit"><td class="line">165</td><td class="hits">10</td><td class="source">                return config.chains[name]</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">167</td><td class="hits">2</td><td class="source">            paths = [paths] unless Array.isArray(paths)</td></tr><tr class="hit"><td class="line">168</td><td class="hits">2</td><td class="source">            type = confTypes[type] || confTypes['JSON']</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">            # if dnschain's config specifies this chain's config path, prioritize it</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">            # fixes: https://github.com/okTurtles/dnschain/issues/60</td></tr><tr class="hit"><td class="line">172</td><td class="hits">2</td><td class="source">            customConfigPath = config.chains.dnschain.get &quot;#{name}:config&quot;</td></tr><tr class="hit"><td class="line">173</td><td class="hits">2</td><td class="source">            if customConfigPath?</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                paths = [customConfigPath]</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                log.info &quot;custom config path for #{name}: #{paths[0]}&quot;</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">177</td><td class="hits">2</td><td class="source">            confFile = _.find paths, (x) -&gt; fs.existsSync x</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">179</td><td class="hits">2</td><td class="source">            unless confFile</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                log.warn &quot;Couldn't find #{name} configuration:&quot;.bold.yellow, paths</td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">                return</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">183</td><td class="hits">2</td><td class="source">            conf = (new nconf.Provider()).argv().env()</td></tr><tr class="hit"><td class="line">184</td><td class="hits">2</td><td class="source">            log.info &quot;#{name} configuration path: #{confFile}&quot;</td></tr><tr class="hit"><td class="line">185</td><td class="hits">2</td><td class="source">            conf.file 'user', {file: confFile, format: type}</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">            # if dnschain's config specifies this chain's config information, use it as default</td></tr><tr class="hit"><td class="line">187</td><td class="hits">2</td><td class="source">            if config.chains.dnschain.get(&quot;#{name}&quot;)?</td></tr><tr class="hit"><td class="line">188</td><td class="hits">1</td><td class="source">                conf.defaults config.chains.dnschain.get &quot;#{name}&quot;</td></tr><tr class="hit"><td class="line">189</td><td class="hits">2</td><td class="source">            config.chains[name] = conf</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/dns.coffee">src/lib/dns.coffee</h2><div id="stats" class="medium"><div class="percentage">65%</div><div class="sloc">143</div><div class="hits">93</div><div class="misses">50</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"># TODO: go through 'TODO's!</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">Packet = require('native-dns-packet')</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">21</td><td class="hits">28</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    QTYPE_NAME = dns2.consts.QTYPE_TO_NAME</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    NAME_QTYPE = dns2.consts.NAME_TO_QTYPE</td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    NAME_RCODE = dns2.consts.NAME_TO_RCODE</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    RCODE_NAME = dns2.consts.RCODE_TO_NAME</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    class DNSServer</td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">30</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'DNS'</td></tr><tr class="hit"><td class="line">31</td><td class="hits">6</td><td class="source">            @log.debug &quot;Loading DNSServer...&quot;</td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">            @method = gConf.get 'dns:oldDNSMethod'</td></tr><tr class="hit"><td class="line">33</td><td class="hits">6</td><td class="source">            @rateLimiting = gConf.get 'rateLimiting:dns'</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            # this is just for development testing of NODE_DNS method</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            # dns.setServers ['8.8.8.8']</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">6</td><td class="source">            if @method is gConsts.oldDNS.NODE_DNS</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                @log.warn &quot;Using&quot;.bold.red, &quot;oldDNSMethod = NODE_DNS&quot;.bold, &quot;method is strongly discouraged!&quot;.bold.red</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">                if dns.getServers?</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">                    blacklist = _.intersection ['127.0.0.1', '::1', 'localhost'], dns.getServers()</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    if blacklist.length &gt; 0</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                        gErr &quot;Cannot use NODE_DNS method when system DNS lists %j as a resolver! Would lead to infinite loop!&quot;, blacklist</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                    gErr &quot;Node's DNS module doesn't have 'getServers'. Please upgrade NodeJS.&quot;</td></tr><tr class="hit"><td class="line">46</td><td class="hits">6</td><td class="source">            else if @method is gConsts.oldDNS.NO_OLD_DNS</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                @log.warn &quot;oldDNSMethod is set to refuse queries for traditional DNS!&quot;.bold</td></tr><tr class="hit"><td class="line">48</td><td class="hits">6</td><td class="source">            else if @method is gConsts.oldDNS.NO_OLD_DNS_EVER</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                @log.warn &quot;oldDNSMethod is set to refuse *ALL* queries for traditional DNS (even if the blockchain wants us to)!&quot;.bold.red</td></tr><tr class="hit"><td class="line">50</td><td class="hits">6</td><td class="source">            else if @method isnt gConsts.oldDNS.NATIVE_DNS</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">                gErr &quot;No such oldDNSMethod: #{@method}&quot;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">6</td><td class="source">            @startCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">57</td><td class="hits">6</td><td class="source">                @server = dns2.createServer() or gErr &quot;dns2 create&quot;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">6</td><td class="source">                @server.on 'socketError', (err) -&gt; gErr err</td></tr><tr class="hit"><td class="line">59</td><td class="hits">6</td><td class="source">                @server.on 'request', (req, res) =&gt;</td></tr><tr class="hit"><td class="line">60</td><td class="hits">120</td><td class="source">                    domain = req.question[0]?.name</td></tr><tr class="hit"><td class="line">61</td><td class="hits">120</td><td class="source">                    if domain</td></tr><tr class="hit"><td class="line">62</td><td class="hits">120</td><td class="source">                        domain = domain.split(&quot;.&quot;)</td></tr><tr class="hit"><td class="line">63</td><td class="hits">120</td><td class="source">                        if domain.length &gt; 3</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                            # if there are more than 3 parts to the domain, we use the last</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                            # letter of the fourth, and the full parts of the last three</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                            # This isn't perfect, especially because of:</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                            # https://publicsuffix.org/list/effective_tld_names.dat</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                            #</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                            # See: https://github.com/okTurtles/dnschain/issues/107 !</td></tr><tr class="hit"><td class="line">70</td><td class="hits">13</td><td class="source">                            domain = [domain[-4..][0][-1..]].concat(domain[-3..]).join '.'</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                        else</td></tr><tr class="hit"><td class="line">72</td><td class="hits">107</td><td class="source">                            domain = domain[-3..].join '.'</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">74</td><td class="hits">120</td><td class="source">                        key = &quot;dns-#{req.address.address}-#{domain}&quot;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">120</td><td class="source">                        @log.debug gLineInfo(&quot;creating bottleneck on: #{key}&quot;)</td></tr><tr class="hit"><td class="line">76</td><td class="hits">120</td><td class="source">                        limiter = gThrottle key, =&gt; new Bottleneck _.at(@rateLimiting, ['maxConcurrent', 'minTime', 'highWater', 'strategy'])...</td></tr><tr class="hit"><td class="line">77</td><td class="hits">120</td><td class="source">                        limiter.changePenalty(@rateLimiting.penalty).submit (@callback.bind @), req, res, null</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                        @log.warn gLineInfo('received empty request!'), {req:req}</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                # // end on 'request'</td></tr><tr class="hit"><td class="line">81</td><td class="hits">6</td><td class="source">                @server.on 'listening', =&gt;</td></tr><tr class="hit"><td class="line">82</td><td class="hits">6</td><td class="source">                    @log.info 'started DNS', gConf.get 'dns'</td></tr><tr class="hit"><td class="line">83</td><td class="hits">6</td><td class="source">                    cb()</td></tr><tr class="hit"><td class="line">84</td><td class="hits">6</td><td class="source">                @server.serve gConf.get('dns:port'), gConf.get('dns:host')</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        shutdown: -&gt;</td></tr><tr class="hit"><td class="line">87</td><td class="hits">6</td><td class="source">            @shutdownCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">88</td><td class="hits">6</td><td class="source">                if @server</td></tr><tr class="hit"><td class="line">89</td><td class="hits">6</td><td class="source">                    @server.on 'close', cb</td></tr><tr class="hit"><td class="line">90</td><td class="hits">6</td><td class="source">                    @server.close()</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">                    @log.warn gLineInfo '@server not defined!'</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                    cb()</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        # (Notes on 'native-dns' version &lt;=0.6.x, which I'd like to see changed.)</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        # Both `req` and `res` are of type `Packet` (the subclass, as explained next).</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        # The packet that's inside of 'native-dns' inherits from the one inside of 'native-dns-packet'.</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        # It adds two extra fields (at this time of writing):</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        # - address: added by Server.prototype.handleMessage and the Packet subclass constructor</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        # - _socket: added by the Packet subclass constructor in lib/packet.js</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        # `req` and `res` are both instances of this subclass of 'Packet'.</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        # They also have the same 'question' field.</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        # See also:</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        # - native-dns/lib/server.js</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        # - native-dns/lib/packet.js</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        # - native-dns-packet/packet.js</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">        # Separately, there is a 'Request' class defined in 'native-dns/lib/client.js'.</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        # Like 'Packet', it has a 'send' method.</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        # To understand it see these functions in 'lib/pending.js':</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        # - SocketQueue.prototype._dequeue   (sending)</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        # - SocketQueue.prototype._onmessage (receiving)</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        # When you create a 'new Request' and send it, it will first create a 'new Packet' and copy</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        # some of the values from the request into it, and then call 'send' on that.</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        # Similarly, in receiving a reply from a Request instance, handle the 'message' event, which</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        # will create a new Packet (the subclass, with the _socket field) from the received data.</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        # See also:</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        # - native-dns/lib/client.js</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">        # - native-dns/lib/pending.js</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">        # Ideally we want to be able to reuse the 'req' received here and pass it along</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">        # to oldDNSLookup without having to recreate or copy any information.</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">        # See: https://github.com/tjfontaine/node-dns/issues/69</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">        # Even more ideally we want to be able to simply pass along the raw data without having to parse it.</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        # See: https://github.com/okTurtles/dnschain/issues/6</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        #</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        callback: (req, res, cb) -&gt;</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">            # answering multiple questions in a query appears to be problematic,</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">            # and few servers do it, so we only answer the first question:</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">            # https://stackoverflow.com/questions/4082081/requesting-a-and-aaaa-records-in-single-dns-query</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">            # At some point we may still want to support this though.</td></tr><tr class="hit"><td class="line">141</td><td class="hits">112</td><td class="source">            q = req.question[qIdx=0]</td></tr><tr class="hit"><td class="line">142</td><td class="hits">112</td><td class="source">            q.name = q.name.toLowerCase()</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">144</td><td class="hits">112</td><td class="source">            ttl = Math.floor(Math.random() * 3600) + 30 # TODO: pick an appropriate TTL value!</td></tr><tr class="hit"><td class="line">145</td><td class="hits">112</td><td class="source">            @log.debug &quot;received question&quot;, q</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">147</td><td class="hits">112</td><td class="source">            if (datastore = @dnschain.chainsTLDs[q.name.split('.').pop()])</td></tr><tr class="hit"><td class="line">148</td><td class="hits">7</td><td class="source">                @log.debug gLineInfo(&quot;resolving via #{datastore.name}...&quot;), {domain:q.name, q:q}</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">150</td><td class="hits">7</td><td class="source">                if not datastore.resources.key?</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">                    @log.error gLineInfo &quot;#{datastore.name} does not implement `key` resource!&quot;.bold</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">                    return @sendErr(res, NAME_RCODE.SERVFAIL, cb)</td></tr><tr class="hit"><td class="line">153</td><td class="hits">7</td><td class="source">                args = [datastore.name , &quot;key&quot;, q.name, null, null, {}] # args conform to the datastore API</td></tr><tr class="hit"><td class="line">154</td><td class="hits">7</td><td class="source">                resourceRequest = (cb) =&gt;</td></tr><tr class="hit"><td class="line">155</td><td class="hits">6</td><td class="source">                    datastore.resources.key.call datastore, args[2..]..., cb</td></tr><tr class="hit"><td class="line">156</td><td class="hits">7</td><td class="source">                @dnschain.cache.resolveResource datastore, resourceRequest, JSON.stringify(args), (err, result) =&gt;</td></tr><tr class="hit"><td class="line">157</td><td class="hits">7</td><td class="source">                    if err? or !result</td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">                        @log.error gLineInfo(&quot;#{datastore.name} failed to resolve&quot;), {err:err?.message, result:result, q:q}</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                        @sendErr res, null, cb</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="hit"><td class="line">161</td><td class="hits">7</td><td class="source">                        @log.debug gLineInfo(&quot;#{datastore.name} resolved query&quot;), {q:q, d:q.name, result:result}</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">163</td><td class="hits">7</td><td class="source">                        if not (handler = datastore.dnsHandler[QTYPE_NAME[q.type]])</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">                            @log.warn gLineInfo(&quot;no such DNS handler!&quot;), {datastore: datastore.name, q:q, type: QTYPE_NAME[q.type]}</td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">                            return @sendErr res, NAME_RCODE.NOTIMP, cb</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">167</td><td class="hits">7</td><td class="source">                        handler.call datastore, req, res, qIdx, result.data, (errCode) =&gt;</td></tr><tr class="hit"><td class="line">168</td><td class="hits">7</td><td class="source">                            try</td></tr><tr class="hit"><td class="line">169</td><td class="hits">7</td><td class="source">                                if errCode</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                                    @sendErr res, errCode, cb</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                                else</td></tr><tr class="hit"><td class="line">172</td><td class="hits">7</td><td class="source">                                    @sendRes res, cb</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                            catch e</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                                @log.error e.stack</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                                @log.error gLineInfo(&quot;exception in handler&quot;), {q:q, result:result}</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                                return @sendErr res, NAME_RCODE.SERVFAIL, cb</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">178</td><td class="hits">105</td><td class="source">            else if S(q.name).endsWith '.dns'</td></tr><tr class="hit"><td class="line">179</td><td class="hits">1</td><td class="source">                res.answer.push gIP2type(q.name,ttl,QTYPE_NAME[q.type])(gConf.get 'dns:externalIP')</td></tr><tr class="hit"><td class="line">180</td><td class="hits">1</td><td class="source">                @log.debug gLineInfo('cb|.dns'), {q:q, answer:res.answer}</td></tr><tr class="hit"><td class="line">181</td><td class="hits">1</td><td class="source">                @sendRes res, cb</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">            else</td></tr><tr class="hit"><td class="line">183</td><td class="hits">104</td><td class="source">                @log.debug gLineInfo(&quot;resolving #{q.name} via oldDNS&quot;), {q:q}</td></tr><tr class="hit"><td class="line">184</td><td class="hits">104</td><td class="source">                @dnschain.cache.resolveOldDNS req, (code, packet) =&gt;</td></tr><tr class="hit"><td class="line">185</td><td class="hits">104</td><td class="source">                    _.assign res, packet</td></tr><tr class="hit"><td class="line">186</td><td class="hits">104</td><td class="source">                    if code</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                        @sendErr res, code, cb</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="hit"><td class="line">189</td><td class="hits">104</td><td class="source">                        @sendRes res, cb</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">        # / end callback</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">        oldDNSLookup: (req, cb) -&gt;</td></tr><tr class="hit"><td class="line">193</td><td class="hits">83</td><td class="source">            res = new Packet()</td></tr><tr class="hit"><td class="line">194</td><td class="hits">83</td><td class="source">            sig = &quot;oldDNS{#{@method}}&quot;</td></tr><tr class="hit"><td class="line">195</td><td class="hits">83</td><td class="source">            q = req.question[0]</td></tr><tr class="hit"><td class="line">196</td><td class="hits">83</td><td class="source">            filterRes = (p) -&gt;</td></tr><tr class="hit"><td class="line">197</td><td class="hits">83</td><td class="source">                _.pick p, ['edns_version', 'edns_options', 'edns', 'answer', 'authority', 'additional']</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">199</td><td class="hits">83</td><td class="source">            @log.debug {fn:sig+':start', q:q}</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">201</td><td class="hits">83</td><td class="source">            if @method is gConsts.oldDNS.NATIVE_DNS</td></tr><tr class="hit"><td class="line">202</td><td class="hits">83</td><td class="source">                success = false</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">                # TODO: retry in TCP-mode on truncated response (like `dig`)</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">                #       See: https://github.com/tjfontaine/node-dns/issues/70</td></tr><tr class="hit"><td class="line">205</td><td class="hits">83</td><td class="source">                req2 = new dns2.Request</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">                    question: q</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">                    server  : gConf.get 'dns:oldDNS'</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">                    try_edns: q.type is NAME_QTYPE.ANY or req.edns?</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">                # 'answer' is a Packet subclass with the .address and ._socket fields</td></tr><tr class="hit"><td class="line">211</td><td class="hits">83</td><td class="source">                req2.on 'message', (err, answer) =&gt;</td></tr><tr class="hit"><td class="line">212</td><td class="hits">83</td><td class="source">                    if err?</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">                        @log.error gLineInfo(&quot;should not have an error here!&quot;), {err:err?.message, answer:answer}</td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">                        req2.DNSErr ?= err</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="hit"><td class="line">216</td><td class="hits">83</td><td class="source">                        @log.debug gLineInfo('message'), {answer:answer}</td></tr><tr class="hit"><td class="line">217</td><td class="hits">83</td><td class="source">                        success = true</td></tr><tr class="hit"><td class="line">218</td><td class="hits">83</td><td class="source">                        res = answer</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">83</td><td class="source">                req2.on 'error', (err={message:'unknown error'}) =&gt;</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">                    @log.error gLineInfo('oldDNS lookup error'), {err:err?.message}</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">                    req2.DNSErr = err</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">224</td><td class="hits">83</td><td class="source">                req2.on 'timeout', (err={message:'timeout'}) =&gt;</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">                    @log.warn gLineInfo('oldDNS timeout'), {err:err}</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                    req2.DNSErr = err</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">228</td><td class="hits">83</td><td class="source">                req2.on 'end', =&gt;</td></tr><tr class="hit"><td class="line">229</td><td class="hits">83</td><td class="source">                    if success</td></tr><tr class="hit"><td class="line">230</td><td class="hits">83</td><td class="source">                        @log.debug gLineInfo('success!'), {q:q, res: _.omit(res, '_socket')}</td></tr><tr class="hit"><td class="line">231</td><td class="hits">83</td><td class="source">                        cb null, filterRes(res)</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                    else</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                        # TODO: this is noisy.</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">                        #       also make log output look good in journalctl</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">                        # you can log IP with: res._socket.remote.address</td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="source">                        @log.warn gLineInfo('oldDNS lookup failed'), {q:q, err:req2.DNSErr}</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">                        cb NAME_RCODE.SERVFAIL, filterRes(res)</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">                # @log.debug {fn:&quot;beforesend&quot;, req:req2}</td></tr><tr class="hit"><td class="line">239</td><td class="hits">83</td><td class="source">                req2.send()</td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="source">            else if @method is gConsts.oldDNS.NODE_DNS</td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="source">                dns.resolve q.name, QTYPE_NAME[q.type], (err, addrs) =&gt;</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">                    if err</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                        @log.debug {fn:sig+':fail', q:q, err:err?.message}</td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="source">                        cb NAME_RCODE.SERVFAIL, filterRes(res)</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">                    else</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">                        # USING THIS METHOD IS DISCOURAGED BECAUSE IT DOESN'T</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">                        # PROVIDE US WITH CORRECT TTL VALUES!!</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">                        # TODO: pick an appropriate TTL value!</td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="source">                        ttl = Math.floor(Math.random() * 3600) + 30</td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="source">                        res.answer.push (addrs.map gIP2type(q.name, ttl, QTYPE_NAME[q.type]))...</td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">                        @log.debug {fn:sig+':success', answer:res.answer, q:q.name}</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                        cb null, filterRes(res)</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">            else</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">                # refuse all such queries</td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">                cb NAME_RCODE.REFUSED, res</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">        sendRes: (res, cb) -&gt;</td></tr><tr class="hit"><td class="line">258</td><td class="hits">112</td><td class="source">            try</td></tr><tr class="hit"><td class="line">259</td><td class="hits">112</td><td class="source">                @log.debug gLineInfo(&quot;sending response!&quot;), {res:_.omit(res, '_socket')}</td></tr><tr class="hit"><td class="line">260</td><td class="hits">112</td><td class="source">                res.send()</td></tr><tr class="hit"><td class="line">261</td><td class="hits">112</td><td class="source">                cb()</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">            catch e</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">                @log.error gLineInfo('error trying send response back!'), {msg:e.message, res:_.omit(res, '_socket'), stack:e.stack}</td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">                cb e</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">        sendErr: (res, code=NAME_RCODE.SERVFAIL, cb) -&gt;</td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">            try</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">                res.header.rcode = code</td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo(), {code:code, name:RCODE_NAME[code]}</td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">                res.send()</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">            catch e</td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="source">                @log.error gLineInfo('exception sending error back!'), e.stack</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">            cb()</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">            false # helps other functions pass back an error value</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/dnschain.coffee">src/lib/dnschain.coffee</h2><div id="stats" class="high"><div class="percentage">89%</div><div class="sloc">48</div><div class="hits">43</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"># we don't 'use strict' because i really want to be able to use 'eval' to declare variables</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"># expose global dependencies, functions, and constants into our namespace</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">for k of require('./globals')(exports)</td></tr><tr class="hit"><td class="line">18</td><td class="hits">28</td><td class="source">    eval &quot;var #{k} = exports.globals.#{k};&quot;</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">exports.createServer = (a...) -&gt; new DNSChain a...</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">DNSServer = require('./dns')(exports)</td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">HTTPServer = require('./http')(exports)</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">EncryptedServer = require('./https')(exports)</td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">ResolverCache = require('./cache')(exports)</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">localhosts = -&gt;</td></tr><tr class="hit"><td class="line">28</td><td class="hits">6</td><td class="source">    _.uniq [</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        &quot;127.0.0.&quot;, &quot;10.0.0.&quot;, &quot;192.168.&quot;, &quot;::1&quot;, &quot;fe80::&quot;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        gConf.get('dns:host'), gConf.get('http:host')</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        gConf.get('dns:externalIP'), gExternalIP()</td></tr><tr class="hit"><td class="line">32</td><td class="hits">18</td><td class="source">        _.map(gConf.chains, (c) -&gt; c.get('host'))...</td></tr><tr class="hit"><td class="line">33</td><td class="hits">72</td><td class="source">    ].filter (o)-&gt; typeof(o) is 'string'</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">exports.DNSChain = class DNSChain</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">    constructor: -&gt;</td></tr><tr class="hit"><td class="line">37</td><td class="hits">6</td><td class="source">        @log = gNewLogger 'DNSChain'</td></tr><tr class="hit"><td class="line">38</td><td class="hits">6</td><td class="source">        chainDir = path.join __dirname, 'blockchains'</td></tr><tr class="hit"><td class="line">39</td><td class="hits">6</td><td class="source">        @chains = _.omit(_.mapValues(_.indexBy(fs.readdirSync(chainDir), (file) =&gt;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">24</td><td class="source">            S(file).chompRight('.coffee').s</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        ), (file) =&gt;</td></tr><tr class="hit"><td class="line">42</td><td class="hits">24</td><td class="source">            chain = new (require('./blockchains/'+file)(exports)) @</td></tr><tr class="hit"><td class="line">43</td><td class="hits">24</td><td class="source">            chain.config()</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        ), (chain) =&gt;</td></tr><tr class="hit"><td class="line">45</td><td class="hits">24</td><td class="source">            not chain</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        )</td></tr><tr class="hit"><td class="line">47</td><td class="hits">6</td><td class="source">        @chainsTLDs = _.indexBy _.compact(_.map(@chains, (chain) -&gt;</td></tr><tr class="hit"><td class="line">48</td><td class="hits">24</td><td class="source">            chain if chain.tld?</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        )), 'tld'</td></tr><tr class="hit"><td class="line">50</td><td class="hits">6</td><td class="source">        gConf.localhosts = localhosts.call @</td></tr><tr class="hit"><td class="line">51</td><td class="hits">6</td><td class="source">        @dns = new DNSServer @</td></tr><tr class="hit"><td class="line">52</td><td class="hits">6</td><td class="source">        @http = new HTTPServer @</td></tr><tr class="hit"><td class="line">53</td><td class="hits">6</td><td class="source">        @encryptedserver = new EncryptedServer @</td></tr><tr class="hit"><td class="line">54</td><td class="hits">6</td><td class="source">        @cache = new ResolverCache @</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        # ordered this way to start all external facing servers last</td></tr><tr class="hit"><td class="line">56</td><td class="hits">6</td><td class="source">        @servers = _.values(@chains).concat [@cache, @http, @encryptedserver, @dns]</td></tr><tr class="hit"><td class="line">57</td><td class="hits">6</td><td class="source">        gFillWithRunningChecks @</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    start: -&gt;</td></tr><tr class="hit"><td class="line">60</td><td class="hits">6</td><td class="source">        @startCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">61</td><td class="hits">6</td><td class="source">            Promise.all(@servers.map (s)-&gt; s.start()).then =&gt;</td></tr><tr class="hit"><td class="line">62</td><td class="hits">6</td><td class="source">                [host, port] = ['dns:externalIP', 'dns:port'].map (x)-&gt; gConf.get x</td></tr><tr class="hit"><td class="line">63</td><td class="hits">6</td><td class="source">                @log.info &quot;DNSChain started and advertising DNS on: #{host}:#{port}&quot;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">6</td><td class="source">                if process.getuid() isnt 0 and port isnt 53 and require('tty').isatty process.stdout</td></tr><tr class="hit"><td class="line">66</td><td class="hits">6</td><td class="source">                    @log.warn &quot;DNS port isn't 53!&quot;.bold.red, &quot;While testing you should either run me as root or make sure to set standard ports in the configuration!&quot;.bold</td></tr><tr class="hit"><td class="line">67</td><td class="hits">6</td><td class="source">                cb null</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">            .catch (e) -&gt; cb e</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        .catch (e) =&gt;</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">            @log.error &quot;DNSChain failed to start:&quot;, e.stack</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">            @shutdown()</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">            throw e # re-throw to indicate that this promise failed</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    shutdown: -&gt;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">6</td><td class="source">        @shutdownCheck (cb) =&gt;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            # shutdown servers in the opposite order they were started</td></tr><tr class="hit"><td class="line">77</td><td class="hits">6</td><td class="source">            reversedServers = @servers[..].reverse()</td></tr><tr class="hit"><td class="line">78</td><td class="hits">6</td><td class="source">            Promise.settle reversedServers.map (s, idx) =&gt;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">48</td><td class="source">                name = s?.name || s?.log?.transports.console?.label</td></tr><tr class="hit"><td class="line">80</td><td class="hits">48</td><td class="source">                @log.debug &quot;Shutting down server at idx:#{idx}: #{name}&quot;</td></tr><tr class="hit"><td class="line">81</td><td class="hits">48</td><td class="source">                s?.shutdown()</td></tr><tr class="hit"><td class="line">82</td><td class="hits">6</td><td class="source">            .then -&gt; cb null</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">            .catch (e) -&gt; cb e</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/globals.coffee">src/lib/globals.coffee</h2><div id="stats" class="medium"><div class="percentage">69%</div><div class="sloc">91</div><div class="hits">63</div><div class="misses">28</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    # 1. global dependencies</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    # </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    # IMPORTANT: *ALL* DNSChain globals *MUST* be prefixed with a 'g'</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    #            *EXCEPT* some of the commonly used global module dependencies below.</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    dnschain.globals =</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        rpc        : 'json-rpc2'</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        _          : 'lodash'</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        S          : 'string'</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        dns2       : 'native-dns'</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        gES        : 'event-stream'</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        Bottleneck : 'bottleneck'</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        Promise    : 'bluebird'</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    # Initialize the global rate limiter pool, only an interface will be visible from the outside</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">    limiters = {}</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    # Garbage collect the unused limiters every minute.</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    #This is necessary or else the server will run out of RAM after a few days</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    setInterval -&gt;</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        time = Date.now()</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">        for key,limiter of limiters</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            # Unused in the last 5 minutes</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">            if (limiter._nextRequest+(60*1000*5)) &lt; time</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                delete limiters[key]</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    , 60*1000 # Every minute</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    # no renaming done for these</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    for d in ['dns', 'fs', 'http','net', 'os', 'path', 'tls', 'url', 'util', 'winston']</td></tr><tr class="hit"><td class="line">44</td><td class="hits">10</td><td class="source">        dnschain.globals[d] = d</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    # replace all the string values in dnschain.globals with the module they represent</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    # and expose them into this function's namespace</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">    for k,v of dnschain.globals</td></tr><tr class="hit"><td class="line">49</td><td class="hits">17</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k} = require('#{v}');&quot;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    # 2. global constants</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">    _.assign dnschain.globals, gConsts:</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        # for questions that the blockchain cannot answer (hopefully these will disappear with time)</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        # &gt;&gt; Use the keys (as string values) in your config!   &lt;&lt;</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        # &gt;&gt; Do *NOT* use the numerical values in your config! &lt;&lt;</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        # For now they're supported but their use is DEPRECATED and they *WILL* be removed!</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        oldDNS:</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            # Recommended method</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            NATIVE_DNS: 0 # Use 'native-dns' module (current default). Hopefully merged into NodeJS in the future: https://github.com/joyent/node/issues/6864#issuecomment-32229852</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            #                    !! WARNING !!</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">            # &gt; ! USING 'NODE_DNS' IS __STRONGLY DISCOURAGED__   ! &lt;</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            # &gt; ! BECAUSE IT DOES NOT PROVIDE PROVIDE TTL VALUES ! &lt;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            # &gt; ! ITS USE MAY BE DEPRECATED IN THE FUTURE        ! &lt;</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            NODE_DNS: 1 # Prior to node 0.11.x will ignore dnsOpts.oldDNS and use OS-specified DNS. Currently ignores 'dnsOpts.oldDNS' in favor of OS-specified DNS even in node 0.11.x (simply needs to be implemented). TODO: &lt;- this!</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            # Refuse to resolve domains in the canonical DNS system</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            # unless the blockchain tells us to, in which case the</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            # NATIVE_DNS method will be used for that purpose.</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            NO_OLD_DNS: 2</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">            # Never resolve domains in canonical DNS. Return REFUSED for all such requests.</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            NO_OLD_DNS_EVER: 3</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    # 3. create global functions, and then return the entire globals object</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">    _.assign dnschain.globals, {</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        gExternalIP: do -&gt;</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">            cachedIP = null</td></tr><tr class="hit"><td class="line">79</td><td class="hits">1</td><td class="source">            faces = os.networkInterfaces()</td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">            default_iface = switch</td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">                when os.type() is 'Darwin' and faces.en0? then 'en0'</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">                when os.type() is 'Linux' and faces.eth0? then 'eth0'</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">                else _(faces).keys().find (x)-&gt; !x.match /lo/</td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">            (iface=default_iface, cached=true,fam='IPv4',internal=false) -&gt;</td></tr><tr class="hit"><td class="line">85</td><td class="hits">7</td><td class="source">                cachedIP = switch</td></tr><tr class="hit"><td class="line">86</td><td class="hits">6</td><td class="source">                    when cached and cachedIP then cachedIP</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">                        unless ips = (faces = os.networkInterfaces())[iface]</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                            throw new Error util.format(&quot;No such interface '%s'. Available: %j&quot;, iface, faces)</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">                        if (address = _.find(ips, {family:fam, internal:internal})?.address)</td></tr><tr class="hit"><td class="line">91</td><td class="hits">1</td><td class="source">                            address</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                        else</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                            console.warn &quot;Couldn't find 'address' in:&quot;.bold.red, ips</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                            console.warn &quot;Couldn't figure out external IPv4 IP! Make SURE to manually set it in your configuration!&quot;.bold.red</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">                            &quot;NOT AN IP! SEE: https://github.com/okTurtles/dnschain/issues/111#issuecomment-71958236&quot;</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        gNewLogger: (name) -&gt;</td></tr><tr class="hit"><td class="line">98</td><td class="hits">61</td><td class="source">            new winston.Logger</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                levels: winston.config.cli.levels</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                colors: winston.config.cli.lcolors</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                transports: [</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                    new winston.transports.Console</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                        label:name</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                        level: gConf.get 'log:level'</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">                        colorize: gConf.get 'log:colors'</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                        prettyPrint: gConf.get 'log:pretty'</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                        timestamp: gConf.get 'log:timestamp'</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                ]</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        gErr: (args...) -&gt;</td></tr><tr class="hit"><td class="line">111</td><td class="hits">1</td><td class="source">            e = new Error util.format args...</td></tr><tr class="hit"><td class="line">112</td><td class="hits">1</td><td class="source">            gLogger.error e.stack</td></tr><tr class="hit"><td class="line">113</td><td class="hits">1</td><td class="source">            throw e</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        gFillWithRunningChecks: (server) -&gt;</td></tr><tr class="hit"><td class="line">116</td><td class="hits">55</td><td class="source">            gLineInfo = dnschain.globals.gLineInfo</td></tr><tr class="hit"><td class="line">117</td><td class="hits">55</td><td class="source">            server.startCheck = (cb) -&gt;</td></tr><tr class="hit"><td class="line">118</td><td class="hits">55</td><td class="source">                if @running</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                    @log.warn gLineInfo &quot;Already running!&quot;</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">                    Promise.reject()</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                else</td></tr><tr class="hit"><td class="line">122</td><td class="hits">55</td><td class="source">                    @log.debug &quot;Starting up...&quot;</td></tr><tr class="hit"><td class="line">123</td><td class="hits">55</td><td class="source">                    new Promise (resolve, reject) =&gt;</td></tr><tr class="hit"><td class="line">124</td><td class="hits">55</td><td class="source">                        cb (err, args...) =&gt;</td></tr><tr class="hit"><td class="line">125</td><td class="hits">55</td><td class="source">                            if err</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">                                @log.error gLineInfo(&quot;failed to start&quot;), err</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">                                reject err</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                            else</td></tr><tr class="hit"><td class="line">129</td><td class="hits">55</td><td class="source">                                @log.info &quot;Server started.&quot;, args</td></tr><tr class="hit"><td class="line">130</td><td class="hits">55</td><td class="source">                                @running = true</td></tr><tr class="hit"><td class="line">131</td><td class="hits">55</td><td class="source">                                resolve args</td></tr><tr class="hit"><td class="line">132</td><td class="hits">55</td><td class="source">            server.shutdownCheck = (cb) -&gt;</td></tr><tr class="hit"><td class="line">133</td><td class="hits">55</td><td class="source">                if @running</td></tr><tr class="hit"><td class="line">134</td><td class="hits">55</td><td class="source">                    @log.debug &quot;Shutting down...&quot;</td></tr><tr class="hit"><td class="line">135</td><td class="hits">55</td><td class="source">                    new Promise (resolve, reject) =&gt;</td></tr><tr class="hit"><td class="line">136</td><td class="hits">55</td><td class="source">                        cb (err, args...) =&gt;</td></tr><tr class="hit"><td class="line">137</td><td class="hits">55</td><td class="source">                            if err</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">                                @log.error gLineInfo(&quot;failed to shutdown&quot;), err</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">                                reject err</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                            else</td></tr><tr class="hit"><td class="line">141</td><td class="hits">55</td><td class="source">                                @log.info &quot;Server shutdown successfully.&quot;, args</td></tr><tr class="hit"><td class="line">142</td><td class="hits">55</td><td class="source">                                @running = false</td></tr><tr class="hit"><td class="line">143</td><td class="hits">55</td><td class="source">                                resolve args</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">                    @log.warn gLineInfo &quot;Shutdown called when not running!&quot;</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">                    Promise.reject()</td></tr><tr class="hit"><td class="line">147</td><td class="hits">55</td><td class="source">            server # as a convenience, return the server instance</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">149</td><td class="hits">131</td><td class="source">        gThrottle: (key, makeLimiter) -&gt; limiters[key] ? (limiters[key] = makeLimiter())</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        # TODO: this function should take one parameter: an IP string</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        #       and return either 'A' or 'AAAA'</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        #       A separate function called type2rec should do what the inner fn does</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">        #       https://github.com/okTurtles/dnschain/issues/7</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        gIP2type: (d, ttl, type='A') -&gt;</td></tr><tr class="hit"><td class="line">156</td><td class="hits">7</td><td class="source">            (ip)-&gt; dns2[type] {name:d, address:ip, ttl:ttl}</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        # Currently this function is namecoin-specific.</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        # DANE/TLSA info: https://tools.ietf.org/html/rfc6698</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        # TODO: implement RRSIG from http://tools.ietf.org/html/rfc4034</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        #       as in: dig @8.8.4.4 +dnssec TLSA _443._tcp.good.dane.verisignlabs.com</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">        gTls2tlsa: (tls, ttl, queryname) -&gt;</td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">            [port, protocol] = (queryname.split '.')[0..1].map (o)-&gt; o.replace '_',''</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">            if !tls?[protocol]?[port]?</td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">                return []</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">            tls[protocol][port].map (certinfo) -&gt;</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">                dns2.TLSA</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                    name: queryname</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                    ttl: ttl</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                    usage: 3     # 3 = &quot;Fuck CAs&quot; :P</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                    selector: 1  # SubjectPublicKeyInfo: DER-encoded [RFC5280]</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                    matchingtype: certinfo[0]</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                    buff: new Buffer certinfo[1], 'hex'</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">        gLineInfo: (prefix='') -&gt;</td></tr><tr class="hit"><td class="line">176</td><td class="hits">625</td><td class="source">            stack = new Error().stack</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">            # console.log stack.split('\n')[2]</td></tr><tr class="hit"><td class="line">178</td><td class="hits">625</td><td class="source">            [file, line] = stack.split('\n')[2].split ':'</td></tr><tr class="hit"><td class="line">179</td><td class="hits">625</td><td class="source">            [func, file] = file.split ' ('</td></tr><tr class="hit"><td class="line">180</td><td class="hits">625</td><td class="source">            [func, file] = ['??', func] unless file # sometimes the function isn't specified</td></tr><tr class="hit"><td class="line">181</td><td class="hits">625</td><td class="source">            [func, file] = [func.split(' ').pop(), path.basename(file)]</td></tr><tr class="hit"><td class="line">182</td><td class="hits">625</td><td class="source">            [junk, func] = func.split('.')</td></tr><tr class="hit"><td class="line">183</td><td class="hits">625</td><td class="source">            func = junk unless func</td></tr><tr class="hit"><td class="line">184</td><td class="hits">625</td><td class="source">            func = if func is '??' or func is '&lt;anonymous&gt;' then ' (' else &quot; (&lt;#{func}&gt; &quot;</td></tr><tr class="hit"><td class="line">185</td><td class="hits">625</td><td class="source">            prefix + func + file + ':' + line + ')'</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    # 4. vars for use within the map above and elsewhere</td></tr><tr class="hit"><td class="line">189</td><td class="hits">1</td><td class="source">    gConf = dnschain.globals.gConf = require('./config')(dnschain)</td></tr><tr class="hit"><td class="line">190</td><td class="hits">1</td><td class="source">    gLogger = dnschain.globals.gLogger = dnschain.globals.gNewLogger 'Global'</td></tr><tr class="hit"><td class="line">191</td><td class="hits">1</td><td class="source">    gConsts = dnschain.globals.gConsts</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">    # handle DEPRECATED numerical oldDNSMethod values</td></tr><tr class="hit"><td class="line">194</td><td class="hits">1</td><td class="source">    method = gConf.get 'dns:oldDNSMethod'</td></tr><tr class="hit"><td class="line">195</td><td class="hits">1</td><td class="source">    if typeof method isnt 'string'</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">        method = _.keys(_.pick gConsts.oldDNS, (v,k)-&gt; v is method)[0]</td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">        gLogger.warn &quot;Specifying 'oldDNSMethod' as a number is DEPRECATED!&quot;.bold.red</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">        gLogger.warn &quot;Please specify the string value instead:&quot;.bold.red, &quot;#{method}&quot;.bold</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    else</td></tr><tr class="hit"><td class="line">200</td><td class="hits">1</td><td class="source">        if _.isNumber (method_num = gConsts.oldDNS[method])</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">            # kinda hackish... but makes for easy and quick comparisons</td></tr><tr class="hit"><td class="line">202</td><td class="hits">1</td><td class="source">            gConf.set 'dns:oldDNSMethod', method_num</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">        else</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">            gLogger.error &quot;No such oldDNS method:&quot;.bold.red, method.bold</td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">            process.exit 1</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">    # 5. return the globals object</td></tr><tr class="hit"><td class="line">209</td><td class="hits">1</td><td class="source">    dnschain.globals</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/http.coffee">src/lib/http.coffee</h2><div id="stats" class="high"><div class="percentage">86%</div><div class="sloc">74</div><div class="hits">64</div><div class="misses">10</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">express = require 'express'</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">19</td><td class="hits">28</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    class HTTPServer</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">23</td><td class="hits">6</td><td class="source">            @log = gNewLogger 'HTTP'</td></tr><tr class="hit"><td class="line">24</td><td class="hits">6</td><td class="source">            @log.debug &quot;Loading HTTPServer...&quot;</td></tr><tr class="hit"><td class="line">25</td><td class="hits">6</td><td class="source">            @rateLimiting = gConf.get 'rateLimiting:http'</td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">            app = express()</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            # Openname spec defined here:</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            # - https://github.com/okTurtles/openname-specifications/blob/resolvers/resolvers.md</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            # - https://github.com/openname/openname-specifications/blob/master/resolvers.md</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">            opennameRoute = express.Router()</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            # Resolver specific API</td></tr><tr class="hit"><td class="line">35</td><td class="hits">6</td><td class="source">            opennameRoute.get /\/(?:resolver|dnschain)\/([^\/\.]+)(?:\.([a-z]+))?/, (req, res) =&gt;</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">                @log.debug gLineInfo(&quot;resolver API called&quot;), {params: req.params}</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">                [resource, format] = req.params</td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">                if resource == &quot;fingerprint&quot;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">                    if !format or format is 'json'</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">                        res.json {fingerprint: @dnschain.encryptedserver.getFingerprint()}</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                        @sendErr req, res, 400, &quot;Unsupported format: #{format}&quot;</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                    @sendErr req, res, 400, &quot;Bad resource: #{resource}&quot;</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            # Datastore API</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            # Note: JavaScript doesn't have negative lookbehind support</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            #       so we use the negative lookahead hacks mentioned here:</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            #       https://stackoverflow.com/questions/977251/regular-expressions-and-negating-a-whole-character-group</td></tr><tr class="hit"><td class="line">50</td><td class="hits">6</td><td class="source">            opennameRoute.route(/// ^</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                \/(\w+)                             # the datastore name</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                \/(\w+)                             # the corresponding resource</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                (?:\/((?:(?!\.json|\.xml)[^\/])+))? # optional property (or action on resource)</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                (?:\/((?:(?!\.json|\.xml)[^\/])+))? # optional action on property</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                (?:\.(json|xml))?                   # optional response format</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                $ ///</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            ).get (req, res) =&gt;</td></tr><tr class="hit"><td class="line">58</td><td class="hits">6</td><td class="source">                @log.debug gLineInfo(&quot;get v1&quot;), {params: req.params, queryArgs: req.query}</td></tr><tr class="hit"><td class="line">59</td><td class="hits">6</td><td class="source">                @callback  req, res, [_.values(req.params)..., req.query]</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">6</td><td class="source">            opennameRoute.use (req, res) =&gt;</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">                @sendErr req, res, 400, &quot;Bad v1 request&quot;</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">6</td><td class="source">            app.use &quot;/v1&quot;, opennameRoute</td></tr><tr class="hit"><td class="line">65</td><td class="hits">6</td><td class="source">            app.get &quot;*&quot;, (req, res) =&gt; # Old, deprecated API usage.</td></tr><tr class="hit"><td class="line">66</td><td class="hits">2</td><td class="source">                path = S(url.parse(req.originalUrl).pathname).chompLeft('/').s</td></tr><tr class="hit"><td class="line">67</td><td class="hits">2</td><td class="source">                options = url.parse(req.originalUrl, true).query</td></tr><tr class="hit"><td class="line">68</td><td class="hits">2</td><td class="source">                @log.debug gLineInfo('deprecated request'), {path:path, options:options, url:req.originalUrl}</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">2</td><td class="source">                [...,datastoreName] =</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                    if S(header = req.headers.blockchain || req.headers.host).endsWith('.dns')</td></tr><tr class="hit"><td class="line">72</td><td class="hits">2</td><td class="source">                        S(header).chompRight('.dns').s.split('.')</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                        ['none']</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">2</td><td class="source">                @callback req, res, [datastoreName, &quot;key&quot;, path, null, null, options]</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">6</td><td class="source">            app.use (err, req, res, next) =&gt;</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                @log.warn gLineInfo('error handler triggered'),</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                    errMessage: err?.message</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                    stack: err?.stack</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    req: _.at(req, ['originalUrl','ip','ips','protocol','hostname','headers'])</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">                res.status(500).send &quot;Internal Error: #{err?.message}&quot;</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">85</td><td class="hits">6</td><td class="source">            @server = http.createServer (req, res) =&gt;</td></tr><tr class="hit"><td class="line">86</td><td class="hits">9</td><td class="source">                key = &quot;http-#{req.connection?.remoteAddress}&quot;</td></tr><tr class="hit"><td class="line">87</td><td class="hits">9</td><td class="source">                @log.debug gLineInfo(&quot;creating bottleneck on: #{key}&quot;)</td></tr><tr class="hit"><td class="line">88</td><td class="hits">9</td><td class="source">                limiter = gThrottle key, =&gt; new Bottleneck _.at(@rateLimiting, ['maxConcurrent','minTime','highWater','strategy'])...</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                # Since Express doesn't take a callback function</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                # we capture the callback that Bottleneck requires</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                # in `bottleCB` and call it by hooking into `res.end`</td></tr><tr class="hit"><td class="line">93</td><td class="hits">9</td><td class="source">                savedEnd = res.end.bind(res)</td></tr><tr class="hit"><td class="line">94</td><td class="hits">9</td><td class="source">                bottleCB = null</td></tr><tr class="hit"><td class="line">95</td><td class="hits">9</td><td class="source">                res.end = (args...) =&gt;</td></tr><tr class="hit"><td class="line">96</td><td class="hits">9</td><td class="source">                    savedEnd args...</td></tr><tr class="hit"><td class="line">97</td><td class="hits">9</td><td class="source">                    bottleCB()</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">9</td><td class="source">                limiter.submit (cb) -&gt;</td></tr><tr class="hit"><td class="line">100</td><td class="hits">9</td><td class="source">                    bottleCB = cb</td></tr><tr class="hit"><td class="line">101</td><td class="hits">9</td><td class="source">                    app req, res</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                , null</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">104</td><td class="hits">6</td><td class="source">            gErr(&quot;http create&quot;) unless @server</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">106</td><td class="hits">6</td><td class="source">            @server.on 'error', (err) -&gt; gErr err</td></tr><tr class="hit"><td class="line">107</td><td class="hits">6</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr class="hit"><td class="line">110</td><td class="hits">6</td><td class="source">            @startCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">111</td><td class="hits">6</td><td class="source">                @server.listen gConf.get('http:port'), gConf.get('http:host'), =&gt;</td></tr><tr class="hit"><td class="line">112</td><td class="hits">6</td><td class="source">                    cb null, gConf.get 'http'</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        shutdown: -&gt;</td></tr><tr class="hit"><td class="line">115</td><td class="hits">6</td><td class="source">            @shutdownCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">116</td><td class="hits">6</td><td class="source">                @log.debug 'shutting down!'</td></tr><tr class="hit"><td class="line">117</td><td class="hits">6</td><td class="source">                @server.close cb</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        callback: (req, res, args) -&gt;</td></tr><tr class="hit"><td class="line">120</td><td class="hits">8</td><td class="source">            [datastoreName, resourceName, propOrAction] = args</td></tr><tr class="hit"><td class="line">121</td><td class="hits">8</td><td class="source">            if not (datastore = @dnschain.chains[datastoreName])</td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="source">                return @sendErr req, res, 400, &quot;Unsupported datastore: #{datastoreName}&quot;</td></tr><tr class="hit"><td class="line">123</td><td class="hits">8</td><td class="source">            if not (resourceFn = datastore.resources[resourceName])</td></tr><tr class="hit"><td class="line">124</td><td class="hits">1</td><td class="source">                return @sendErr req, res, 400, &quot;Unsupported resource: #{resourceName}&quot;</td></tr><tr class="hit"><td class="line">125</td><td class="hits">7</td><td class="source">            resourceRequest = (cb) =&gt;</td></tr><tr class="hit"><td class="line">126</td><td class="hits">7</td><td class="source">                resourceFn.call datastore, args[2..]..., cb</td></tr><tr class="hit"><td class="line">127</td><td class="hits">7</td><td class="source">            @dnschain.cache.resolveResource datastore, resourceRequest, JSON.stringify(args), (err,result) =&gt;</td></tr><tr class="hit"><td class="line">128</td><td class="hits">7</td><td class="source">                if err</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                    err.httpCode ?= 404</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                    @log.debug gLineInfo('resolver failed'), {err:err.message}</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">                    @sendErr req, res, err.httpCode, &quot;Not Found: #{propOrAction}&quot;</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                else</td></tr><tr class="hit"><td class="line">133</td><td class="hits">7</td><td class="source">                    @log.debug gLineInfo('postResolve'), {path:propOrAction, result:result}</td></tr><tr class="hit"><td class="line">134</td><td class="hits">7</td><td class="source">                    res.json result</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        sendErr: (req, res, code=404, comment=&quot;Not Found&quot;) -&gt;</td></tr><tr class="hit"><td class="line">137</td><td class="hits">1</td><td class="source">            if req.originalUrl != '/favicon.ico' # avoid logging these</td></tr><tr class="hit"><td class="line">138</td><td class="hits">1</td><td class="source">                @log.warn gLineInfo('sendErr'),</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                    comment: comment</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                    code: code</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                    req: _.at(req, ['originalUrl','protocol','hostname'])</td></tr><tr class="hit"><td class="line">142</td><td class="hits">1</td><td class="source">            res.status(code).send comment</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/https.coffee">src/lib/https.coffee</h2><div id="stats" class="high"><div class="percentage">77%</div><div class="sloc">106</div><div class="hits">82</div><div class="misses">24</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.org</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">This file contains the logic to handle connections on port 443</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">These connections can be naked HTTPS or wrapped inside of TLS</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">NOTE: There can be any number of EncryptedServers. A good example of that is when running the tests.</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">The TLSServers are shared between EncryptedServers.</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            __________________________        ________________________</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">443 traffic |                        |   *---&gt;|      TLSServer       |     ______________</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">-----------&gt;|     EncryptedServer    |--*     | (Dumb decrypter)     |----&gt;| HTTPServer |----&gt; Multiple destinations</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            |(Categorization/Routing)|   *    | (One of many)        |     ______________</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            __________________________    *   | (Unique destination) |</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                                           *  _______________________|</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                                            *    _____________   Soon</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                                             *--&gt;| TLSServer |----------&gt; Unblock (Vastly simplified)</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                                                 _____________</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">36</td><td class="hits">3</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">37</td><td class="hits">84</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">3</td><td class="source">    libHTTPS = new ((require &quot;./httpsUtils&quot;)(dnschain)) # TODO: httpsUtils doesn't need to be a class</td></tr><tr class="hit"><td class="line">40</td><td class="hits">3</td><td class="source">    pem = (require './pem')(dnschain)</td></tr><tr class="hit"><td class="line">41</td><td class="hits">3</td><td class="source">    httpSettings = gConf.get &quot;http&quot;</td></tr><tr class="hit"><td class="line">42</td><td class="hits">3</td><td class="source">    unblockSettings = gConf.get &quot;unblock&quot;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">3</td><td class="source">    tlsLog = gNewLogger &quot;TLSServer&quot;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">3</td><td class="source">    httpsVars = tls: Promise.resolve()</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">3</td><td class="source">    keyMaterial = _(httpSettings).pick(['tlsKey', 'tlsCert']).transform((o, v, k)-&gt;</td></tr><tr class="hit"><td class="line">48</td><td class="hits">6</td><td class="source">        o[k] = { key:k, path:v, exists: fs.existsSync(v) }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    ).value()</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    # Auto-generate public/private key pair if they don't exist</td></tr><tr class="hit"><td class="line">52</td><td class="hits">3</td><td class="source">    if _.some(keyMaterial, exists:false)</td></tr><tr class="hit"><td class="line">53</td><td class="hits">2</td><td class="source">        missing = _.find(keyMaterial, exists:false)</td></tr><tr class="hit"><td class="line">54</td><td class="hits">2</td><td class="source">        tlsLog.warn &quot;File for http:#{missing.key} does not exist: #{missing.path}&quot;.bold.red</td></tr><tr class="hit"><td class="line">55</td><td class="hits">2</td><td class="source">        tlsLog.warn &quot;Vist this link for information on how to generate this file:&quot;.bold</td></tr><tr class="hit"><td class="line">56</td><td class="hits">2</td><td class="source">        tlsLog.warn &quot;https://github.com/okTurtles/dnschain/blob/master/docs/How-do-I-run-my-own.md#getting-started&quot;.bold</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        # In the case where one file exists but the other does not</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        # we do not auto-generate them for the user (so as to not overwrite anything)      </td></tr><tr class="hit"><td class="line">60</td><td class="hits">2</td><td class="source">        if exists = _.find(keyMaterial, exists:true)</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">            tlsLog.error &quot;\nhttp:#{exists.key} exists at:\n\t&quot;.bold.yellow, exists.path.bold, &quot;\nbut http:#{missing.key} does not exist at:\n\t&quot;.bold.red, missing.path.bold</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">            gErr &quot;Missing file for http:#{missing.key}&quot;</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">        tlsLog.warn &quot;Auto-generating private key and certificate for you...&quot;.bold.yellow</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">        {tlsKey, tlsCert} = gConf.chains.dnschain.stores.defaults.get('http')</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">        unless httpSettings.tlsKey is tlsKey and httpSettings.tlsCert is tlsCert</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">            msg = &quot;Can't autogen keys for you because you've customized their paths&quot;</td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">            if process.env.TEST_DNSCHAIN</td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">                tlsLog.warn &quot;Test detected. Not throwing error:&quot;.bold, msg.bold.yellow</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            else</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                gErr msg</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">        [tlsKey, tlsCert] = [httpSettings.tlsKey, httpSettings.tlsCert]</td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">        httpsVars.tls = pem.genKeyCertPair(tlsKey, tlsCert).then -&gt;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">            tlsLog.info &quot;Successfully autogenerated&quot;, {key:tlsKey, cert:tlsCert}</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    # Fetch the public key fingerprint of the cert we're using and log to console </td></tr><tr class="hit"><td class="line">78</td><td class="hits">2</td><td class="source">    httpsVars.tls = httpsVars.tls.then -&gt;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">2</td><td class="source">        httpsVars.tlsOptions =</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            key: fs.readFileSync httpSettings.tlsKey</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            cert: fs.readFileSync httpSettings.tlsCert</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">83</td><td class="hits">2</td><td class="source">        pem.certFingerprint(httpSettings.tlsCert).then (f) -&gt;</td></tr><tr class="hit"><td class="line">84</td><td class="hits">2</td><td class="source">            httpsVars.fingerprint = f</td></tr><tr class="hit"><td class="line">85</td><td class="hits">2</td><td class="source">            tlsLog.info &quot;Your certificate fingerprint is:&quot;, f.bold</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">87</td><td class="hits">2</td><td class="source">    class EncryptedServer</td></tr><tr class="hit"><td class="line">88</td><td class="hits">2</td><td class="source">        constructor: (@dnschain) -&gt;</td></tr><tr class="hit"><td class="line">89</td><td class="hits">7</td><td class="source">            @log = gNewLogger &quot;HTTPS&quot;</td></tr><tr class="hit"><td class="line">90</td><td class="hits">7</td><td class="source">            @log.debug gLineInfo &quot;Loading HTTPS...&quot;</td></tr><tr class="hit"><td class="line">91</td><td class="hits">7</td><td class="source">            @rateLimiting = gConf.get 'rateLimiting:https'</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">7</td><td class="source">            @server = net.createServer (c) =&gt;</td></tr><tr class="hit"><td class="line">94</td><td class="hits">2</td><td class="source">                key = &quot;https-#{c.remoteAddress}&quot;</td></tr><tr class="hit"><td class="line">95</td><td class="hits">2</td><td class="source">                limiter = gThrottle key, =&gt; new Bottleneck @rateLimiting.maxConcurrent, @rateLimiting.minTime, @rateLimiting.highWater, @rateLimiting.strategy</td></tr><tr class="hit"><td class="line">96</td><td class="hits">2</td><td class="source">                limiter.submit (@callback.bind @), c, null</td></tr><tr class="hit"><td class="line">97</td><td class="hits">7</td><td class="source">            @server.on &quot;error&quot;, (err) -&gt; gErr err</td></tr><tr class="hit"><td class="line">98</td><td class="hits">7</td><td class="source">            @server.on &quot;close&quot;, =&gt; @log.info &quot;HTTPS server received close event.&quot;</td></tr><tr class="hit"><td class="line">99</td><td class="hits">7</td><td class="source">            gFillWithRunningChecks @</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        start: -&gt;</td></tr><tr class="hit"><td class="line">102</td><td class="hits">7</td><td class="source">            @startCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">103</td><td class="hits">7</td><td class="source">                listen = =&gt;</td></tr><tr class="hit"><td class="line">104</td><td class="hits">7</td><td class="source">                    @server.listen httpSettings.tlsPort, httpSettings.host, =&gt;</td></tr><tr class="hit"><td class="line">105</td><td class="hits">7</td><td class="source">                        cb null, httpSettings</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">107</td><td class="hits">7</td><td class="source">                if httpsVars.tls.then</td></tr><tr class="hit"><td class="line">108</td><td class="hits">7</td><td class="source">                    httpsVars.tls.then =&gt;</td></tr><tr class="hit"><td class="line">109</td><td class="hits">7</td><td class="source">                        httpsVars.tls = tls.createServer httpsVars.tlsOptions, (c) =&gt;</td></tr><tr class="hit"><td class="line">110</td><td class="hits">2</td><td class="source">                            libHTTPS.getStream &quot;127.0.0.1&quot;, httpSettings.port, (err, stream) -&gt;</td></tr><tr class="hit"><td class="line">111</td><td class="hits">2</td><td class="source">                                if err?</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                                    tlsLog.error gLineInfo &quot;Tunnel failed: Could not connect to HTTP Server&quot;</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">                                    c?.destroy()</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                                    return stream?.destroy()</td></tr><tr class="hit"><td class="line">115</td><td class="hits">2</td><td class="source">                                c.pipe(stream).pipe(c)</td></tr><tr class="hit"><td class="line">116</td><td class="hits">7</td><td class="source">                        httpsVars.tls.on &quot;error&quot;, (err) -&gt;</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">                            tlsLog.error gLineInfo(), err</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                            gErr err.message</td></tr><tr class="hit"><td class="line">119</td><td class="hits">7</td><td class="source">                        httpsVars.tls.listen httpSettings.internalTLSPort, &quot;127.0.0.1&quot;, -&gt;</td></tr><tr class="hit"><td class="line">120</td><td class="hits">7</td><td class="source">                            tlsLog.info &quot;Listening&quot;</td></tr><tr class="hit"><td class="line">121</td><td class="hits">7</td><td class="source">                            listen()</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">                    listen()</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        shutdown: -&gt;</td></tr><tr class="hit"><td class="line">126</td><td class="hits">7</td><td class="source">            @shutdownCheck (cb) =&gt;</td></tr><tr class="hit"><td class="line">127</td><td class="hits">7</td><td class="source">                httpsVars.tls.close() # node docs don't indicate this takes a callback</td></tr><tr class="hit"><td class="line">128</td><td class="hits">7</td><td class="source">                httpsVars.tls = Promise.resolve() # TODO: Simon, this hack is necessary</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                                                  #       because without it test/https.coffee</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                                                  #       breaks if it is not run first.</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                                                  #       This happens because of the</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                                                  #       `if httpsVars.tls.then` above</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                                                  #       in `start:`.</td></tr><tr class="hit"><td class="line">134</td><td class="hits">7</td><td class="source">                @server.close cb</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        callback: (c, cb) -&gt;</td></tr><tr class="hit"><td class="line">137</td><td class="hits">2</td><td class="source">            libHTTPS.getClientHello c, (err, category, host, buf) =&gt;</td></tr><tr class="hit"><td class="line">138</td><td class="hits">2</td><td class="source">                @log.debug err, category, host, buf?.length</td></tr><tr class="hit"><td class="line">139</td><td class="hits">2</td><td class="source">                if err?</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">                    @log.debug gLineInfo &quot;TCP handling: &quot;+err.message</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">                    cb()</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">                    return c?.destroy()</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                # UNBLOCK: Check if needs to be hijacked</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">146</td><td class="hits">2</td><td class="source">                isRouted = false # unblockSettings.enabled and unblockSettings.routeDomains[host]?</td></tr><tr class="hit"><td class="line">147</td><td class="hits">2</td><td class="source">                isDNSChain = (</td></tr><tr class="hit"><td class="line">148</td><td class="hits">2</td><td class="source">                    (category == libHTTPS.categories.NO_SNI) or</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">                    ((not unblockSettings.enabled) and category == libHTTPS.categories.SNI) or</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">                    (unblockSettings.enabled and (host in unblockSettings.acceptApiCallsTo)) or</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">                    ((host?.split(&quot;.&quot;)[-1..][0]) == &quot;dns&quot;)</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                )</td></tr><tr class="hit"><td class="line">153</td><td class="hits">2</td><td class="source">                isUnblock = false</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">155</td><td class="hits">2</td><td class="source">                [destination, port, error] = if isRouted</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">                    [&quot;127.0.0.1&quot;, unblockSettings.routeDomains[host], false]</td></tr><tr class="hit"><td class="line">157</td><td class="hits">2</td><td class="source">                else if isDNSChain</td></tr><tr class="hit"><td class="line">158</td><td class="hits">2</td><td class="source">                    [&quot;127.0.0.1&quot;, httpSettings.internalTLSPort, false]</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                else if isUnblock</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                    [host, 443, false]</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                else</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                    [&quot;&quot;, -1, true]</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">164</td><td class="hits">2</td><td class="source">                if error</td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">                    @log.error &quot;Illegal domain (#{host})&quot;</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                    cb()</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">                    return c?.destroy()</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">169</td><td class="hits">2</td><td class="source">                libHTTPS.getStream destination, port, (err, stream) =&gt;</td></tr><tr class="hit"><td class="line">170</td><td class="hits">2</td><td class="source">                    if err?</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                        @log.error gLineInfo &quot;Tunnel failed: Could not connect to internal TLS Server&quot;</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                        c?.destroy()</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                        cb()</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                        return stream?.destroy()</td></tr><tr class="hit"><td class="line">175</td><td class="hits">2</td><td class="source">                    stream.write buf</td></tr><tr class="hit"><td class="line">176</td><td class="hits">2</td><td class="source">                    c.pipe(stream).pipe(c)</td></tr><tr class="hit"><td class="line">177</td><td class="hits">2</td><td class="source">                    c.resume()</td></tr><tr class="hit"><td class="line">178</td><td class="hits">2</td><td class="source">                    @log.debug gLineInfo &quot;Tunnel: #{host}&quot;</td></tr><tr class="hit"><td class="line">179</td><td class="hits">2</td><td class="source">                    cb()</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">181</td><td class="hits">1</td><td class="source">        getFingerprint: -&gt; httpsVars.fingerprint</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/httpsUtils.coffee">src/lib/httpsUtils.coffee</h2><div id="stats" class="high"><div class="percentage">76%</div><div class="sloc">88</div><div class="hits">67</div><div class="misses">21</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.org</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">15</td><td class="hits">3</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">16</td><td class="hits">84</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    # http://tools.ietf.org/html/rfc5246#section-7.4.1</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    # http://stackoverflow.com/questions/17832592/extract-server-name-indication-sni-from-tls-client-hello</td></tr><tr class="hit"><td class="line">20</td><td class="hits">3</td><td class="source">    class HTTPSUtils</td></tr><tr class="hit"><td class="line">21</td><td class="hits">3</td><td class="source">        categories: {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            SNI : 0</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            NO_SNI : 1</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            NOT_HTTPS : 2</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            INCOMPLETE : 3</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        parseHTTPS: (packet) -&gt;</td></tr><tr class="hit"><td class="line">29</td><td class="hits">2</td><td class="source">            res = {}</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">            try</td></tr><tr class="hit"><td class="line">31</td><td class="hits">2</td><td class="source">                res.contentType = packet.readUInt8 0</td></tr><tr class="hit"><td class="line">32</td><td class="hits">2</td><td class="source">                if res.contentType != 22 then return [@categories.NOT_HTTPS, {}]</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">2</td><td class="source">                res.recordVersionMajor = packet.readUInt8 1</td></tr><tr class="hit"><td class="line">35</td><td class="hits">2</td><td class="source">                if res.recordVersionMajor &gt;= 7 then return [@categories.NOT_HTTPS, {}]</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">2</td><td class="source">                res.recordVersionMinor = packet.readUInt8 2</td></tr><tr class="hit"><td class="line">38</td><td class="hits">2</td><td class="source">                if res.recordVersionMinor &gt;= 7 then return [@categories.NOT_HTTPS, {}]</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">2</td><td class="source">                res.recordLength = packet.readUInt16BE 3</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">                res.handshakeType = packet.readUInt8 5</td></tr><tr class="hit"><td class="line">43</td><td class="hits">2</td><td class="source">                if res.handshakeType != 1 then return [@categories.NOT_HTTPS, {}]</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">2</td><td class="source">                res.handshakeLength = packet[6..8]</td></tr><tr class="hit"><td class="line">46</td><td class="hits">2</td><td class="source">                res.handshakeVersion = packet.readUInt16BE 9</td></tr><tr class="hit"><td class="line">47</td><td class="hits">2</td><td class="source">                res.random = packet[11..42]</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">2</td><td class="source">                res.sessionIDlength = packet.readUInt8 43</td></tr><tr class="hit"><td class="line">50</td><td class="hits">2</td><td class="source">                pos = res.sessionIDlength + 43 + 1</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">2</td><td class="source">                res.cipherSuitesLength = packet.readUInt16BE pos</td></tr><tr class="hit"><td class="line">53</td><td class="hits">2</td><td class="source">                pos += res.cipherSuitesLength + 2</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">55</td><td class="hits">2</td><td class="source">                res.compressionMethodsLength = packet.readUInt8 pos</td></tr><tr class="hit"><td class="line">56</td><td class="hits">2</td><td class="source">                pos += res.compressionMethodsLength + 1</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">2</td><td class="source">                res.extensionsLength = packet.readUInt16BE pos</td></tr><tr class="hit"><td class="line">59</td><td class="hits">2</td><td class="source">                pos += 2</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">2</td><td class="source">                extensionsEnd = pos + res.extensionsLength - 1</td></tr><tr class="hit"><td class="line">62</td><td class="hits">2</td><td class="source">                jump = 0</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">2</td><td class="source">                res.extensions = {}</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">2</td><td class="source">                while pos &lt; extensionsEnd</td></tr><tr class="hit"><td class="line">67</td><td class="hits">6</td><td class="source">                    ext = {}</td></tr><tr class="hit"><td class="line">68</td><td class="hits">6</td><td class="source">                    ext.type = packet.readUInt16BE pos</td></tr><tr class="hit"><td class="line">69</td><td class="hits">6</td><td class="source">                    ext.length = packet.readUInt16BE (pos+2)</td></tr><tr class="hit"><td class="line">70</td><td class="hits">6</td><td class="source">                    jump = ext.length+4</td></tr><tr class="hit"><td class="line">71</td><td class="hits">6</td><td class="source">                    ext.body = packet[pos..(pos+jump-1)]</td></tr><tr class="hit"><td class="line">72</td><td class="hits">6</td><td class="source">                    res.extensions[ext.type] = ext</td></tr><tr class="hit"><td class="line">73</td><td class="hits">6</td><td class="source">                    pos += jump</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">2</td><td class="source">                if res.extensions[&quot;0&quot;]?</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                    sniPos = 0</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">                    sni = res.extensions[&quot;0&quot;]</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">                    sni.sniType = sni.body.readUInt16BE 0</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                    sni.sniLength = sni.body.readUInt16BE 2</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">                    sni.sniList = sni.body.readUInt16BE 4</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">                    sni.sniNameType = sni.body.readUInt8 6</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">                    sni.sniNameLength = sni.body.readUInt16BE 7</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">                    sni.sniName = sni.body[9..(9+sni.sniNameLength)]</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">                    res.host = sni.sniName.toString &quot;utf8&quot;</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                    if res.host.length != sni.sniNameLength then return [@categories.NOT_HTTPS, {}]</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                    return [@categories.SNI, res]</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">                else</td></tr><tr class="hit"><td class="line">88</td><td class="hits">2</td><td class="source">                    return [@categories.NO_SNI, {}]</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            catch ex</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                return [@categories.INCOMPLETE, {}]</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        # Open a TCP socket to a remote host.</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        getStream: (host, port, cb) -&gt;</td></tr><tr class="hit"><td class="line">95</td><td class="hits">4</td><td class="source">            try</td></tr><tr class="hit"><td class="line">96</td><td class="hits">4</td><td class="source">                done = (err, s) -&gt;</td></tr><tr class="hit"><td class="line">97</td><td class="hits">4</td><td class="source">                    done = -&gt;</td></tr><tr class="hit"><td class="line">98</td><td class="hits">4</td><td class="source">                    cb err, s</td></tr><tr class="hit"><td class="line">99</td><td class="hits">4</td><td class="source">                s = net.createConnection {host, port}, -&gt;</td></tr><tr class="hit"><td class="line">100</td><td class="hits">4</td><td class="source">                    done null, s</td></tr><tr class="hit"><td class="line">101</td><td class="hits">4</td><td class="source">                s.on &quot;error&quot;, (err) -&gt; s.destroy(); done err</td></tr><tr class="hit"><td class="line">102</td><td class="hits">4</td><td class="source">                s.on &quot;close&quot;, -&gt; s.destroy()</td></tr><tr class="hit"><td class="line">103</td><td class="hits">4</td><td class="source">                s.on &quot;timeout&quot;, -&gt; s.destroy(); done new Error &quot;getStream timed out&quot;</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            catch err</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">                done err</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        # Received raw TCP data in chunked mode and attempt to extract Hello data</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        # after every chunk. Return as soon as the Hello data has been obtained.</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        getClientHello: (c, cb) -&gt;</td></tr><tr class="hit"><td class="line">110</td><td class="hits">2</td><td class="source">            received = []</td></tr><tr class="hit"><td class="line">111</td><td class="hits">2</td><td class="source">            buf = new Buffer []</td></tr><tr class="hit"><td class="line">112</td><td class="hits">2</td><td class="source">            done = (err, category, host, buf) -&gt;</td></tr><tr class="hit"><td class="line">113</td><td class="hits">2</td><td class="source">                c.removeAllListeners(&quot;data&quot;)</td></tr><tr class="hit"><td class="line">114</td><td class="hits">2</td><td class="source">                done = -&gt;</td></tr><tr class="hit"><td class="line">115</td><td class="hits">2</td><td class="source">                cb err, category, host, buf</td></tr><tr class="hit"><td class="line">116</td><td class="hits">2</td><td class="source">            c.on &quot;data&quot;, (data) =&gt;</td></tr><tr class="hit"><td class="line">117</td><td class="hits">2</td><td class="source">                c.pause()</td></tr><tr class="hit"><td class="line">118</td><td class="hits">2</td><td class="source">                received.push data</td></tr><tr class="hit"><td class="line">119</td><td class="hits">2</td><td class="source">                buf = Buffer.concat received</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">121</td><td class="hits">2</td><td class="source">                [category, parsed] = @parseHTTPS buf</td></tr><tr class="hit"><td class="line">122</td><td class="hits">2</td><td class="source">                switch category</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                    when @categories.SNI</td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="source">                        done null, category, parsed.host, buf</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                    when @categories.NO_SNI</td></tr><tr class="hit"><td class="line">126</td><td class="hits">2</td><td class="source">                        done null, category, null, buf</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    when @categories.NOT_HTTPS</td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="source">                        done new Error &quot;NOT HTTPS&quot;, category, null, buf</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                    when @categories.INCOMPLETE</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                        c.resume()</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">                        done new Error &quot;Unimplemented&quot;, category, null, buf</td></tr><tr class="hit"><td class="line">133</td><td class="hits">2</td><td class="source">            c.on &quot;timeout&quot;, -&gt;</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                c.destroy()</td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">                done new Error &quot;HTTPS getClientHello timeout&quot;</td></tr><tr class="hit"><td class="line">136</td><td class="hits">2</td><td class="source">            c.on &quot;error&quot;, (err) -&gt;</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">                c.destroy()</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">                done err</td></tr><tr class="hit"><td class="line">139</td><td class="hits">2</td><td class="source">            c.on &quot;close&quot;, -&gt;</td></tr><tr class="hit"><td class="line">140</td><td class="hits">2</td><td class="source">                c.destroy()</td></tr><tr class="hit"><td class="line">141</td><td class="hits">2</td><td class="source">                done new Error &quot;HTTPS socket closed&quot;</td></tr></tbody></table></div><div class="file"><h2 id="src/lib/pem.coffee">src/lib/pem.coffee</h2><div id="stats" class="high"><div class="percentage">89%</div><div class="sloc">19</div><div class="hits">17</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.org</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2015 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">16</td><td class="hits">3</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">17</td><td class="hits">84</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">3</td><td class="source">    execAsync = Promise.promisify require('child_process').exec</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">3</td><td class="source">    pem =</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        certFingerprint: (cert, opts={}) -&gt;</td></tr><tr class="hit"><td class="line">23</td><td class="hits">2</td><td class="source">            opts = _.defaults opts, {timeout:1000, encoding:'utf8'}</td></tr><tr class="hit"><td class="line">24</td><td class="hits">2</td><td class="source">            cmd = &quot;openssl x509 -fingerprint -sha256 -text -noout -in \&quot;#{cert}\&quot;&quot;</td></tr><tr class="hit"><td class="line">25</td><td class="hits">2</td><td class="source">            gLogger.debug &quot;running: #{cmd}&quot;</td></tr><tr class="hit"><td class="line">26</td><td class="hits">2</td><td class="source">            execAsync(cmd, opts).spread (stdout, stderr) -&gt;</td></tr><tr class="hit"><td class="line">27</td><td class="hits">2</td><td class="source">                stdout.match(/SHA256 Fingerprint=([0-9A-F:]{95})$/m)[1]</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            .catch (err) -&gt;</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">                gErr &quot;Failed to read public key fingerprint: #{err?.message}&quot;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        genKeyCertPair: (key, cert, opts={}) -&gt;</td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">            opts = _.defaults opts, {timeout:10000, encoding:'utf8'}</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">            cmd = &quot;&quot;&quot;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            openssl req -new -newkey rsa:4096 -days 730 -nodes -sha256 -x509 \</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">                        -subj &quot;/CN=#{os.hostname()}&quot; \</td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">                        -keyout &quot;#{key}&quot; -out &quot;#{cert}&quot;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            &quot;&quot;&quot;</td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">            gLogger.debug &quot;running: #{cmd}&quot;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">            execAsync(cmd, opts).spread (stdout, stderr) -&gt;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">                fs.chmodSync key, 0o600 # rw for owner, 0 for everyone else</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            .catch (err) -&gt;</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                gErr &quot;Failed to generate key material: #{err?.message}&quot;</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/resolver-stream.coffee">src/lib/resolver-stream.coffee</h2><div id="stats" class="medium"><div class="percentage">74%</div><div class="sloc">81</div><div class="hits">60</div><div class="misses">21</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">Transform = require('stream').Transform</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"># objectMode is on by default</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr class="hit"><td class="line">19</td><td class="hits">30</td><td class="source">    StackedScheduler = require('./stacked-scheduler')(dnschain)</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">22</td><td class="hits">30</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">23</td><td class="hits">840</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">30</td><td class="source">    NAME_RCODE = dns2.consts.NAME_TO_RCODE</td></tr><tr class="hit"><td class="line">26</td><td class="hits">30</td><td class="source">    RCODE_NAME = dns2.consts.RCODE_TO_NAME</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">30</td><td class="source">    defaults =</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        name        : 'RS'</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        stackedDelay: 0</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        resolver    : gConf.get 'dns:oldDNS'</td></tr><tr class="hit"><td class="line">32</td><td class="hits">3</td><td class="source">        answerFilter: (a) -&gt; a.address</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        reqMaker    : (cname) -&gt;</td></tr><tr class="hit"><td class="line">34</td><td class="hits">2</td><td class="source">            dns2.Request</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                question: dns2.Question {name:cname, type:'A'} # TODO: is type=A always correct?</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                server: @resolver</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">30</td><td class="source">    class ResolverStream extends Transform</td></tr><tr class="hit"><td class="line">39</td><td class="hits">30</td><td class="source">        constructor: (@opts) -&gt;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">2</td><td class="source">            @opts = _.cloneDeep @opts # clone these for safety in case outside code updates them</td></tr><tr class="hit"><td class="line">41</td><td class="hits">2</td><td class="source">            @opts.objectMode ?= true</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">            defaultProps = _.keys defaults</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            # copy property values in @opts for those keys in 'defaults' into this object</td></tr><tr class="hit"><td class="line">44</td><td class="hits">2</td><td class="source">            _.assign @, _.pick(_.defaults(@opts, defaults), defaultProps)</td></tr><tr class="hit"><td class="line">45</td><td class="hits">2</td><td class="source">            super _.omit @opts, defaultProps</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">2</td><td class="source">            @scheduler  = new StackedScheduler @opts</td></tr><tr class="hit"><td class="line">48</td><td class="hits">2</td><td class="source">            @requests   = {}</td></tr><tr class="hit"><td class="line">49</td><td class="hits">2</td><td class="source">            @reqCounter = 0</td></tr><tr class="hit"><td class="line">50</td><td class="hits">2</td><td class="source">            @errCount   = 0</td></tr><tr class="hit"><td class="line">51</td><td class="hits">2</td><td class="source">            @log = gNewLogger @name</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        cancelRequests: (andStop=false) -&gt;</td></tr><tr class="hit"><td class="line">54</td><td class="hits">2</td><td class="source">            @log.debug 'cancelling requests%s', if andStop then ' and stopping' else ''</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            # cancell all active requests (those that were sent)</td></tr><tr class="hit"><td class="line">57</td><td class="hits">2</td><td class="source">            for id,req of @requests</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                @log.debug &quot;cancelling req-#{req.rsReqID} (should have same id: #{id})&quot;</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                req.cancel()</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                delete @requests[id]</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">            # cancell all pending requests (those to be sent)</td></tr><tr class="hit"><td class="line">63</td><td class="hits">2</td><td class="source">            @scheduler.cancelAll()</td></tr><tr class="hit"><td class="line">64</td><td class="hits">2</td><td class="source">            @stopped = andStop</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        # 'callback' should only be called in req.on 'end'</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        _transform: (cname, encoding, callback) -&gt;</td></tr><tr class="hit"><td class="line">68</td><td class="hits">4</td><td class="source">            if typeof cname != 'string'</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                gErr &quot;cname isn't a string!&quot;, cname</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">4</td><td class="source">            if @stopped</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">                @log.debug gLineInfo(&quot;stopped. not scheduling req for '#{cname}'&quot;)</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">                return callback()</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">3</td><td class="source">            req = @reqMaker(cname)</td></tr><tr class="hit"><td class="line">76</td><td class="hits">3</td><td class="source">            req.rsReqID = @reqCounter++</td></tr><tr class="hit"><td class="line">77</td><td class="hits">3</td><td class="source">            q = req.question</td></tr><tr class="hit"><td class="line">78</td><td class="hits">3</td><td class="source">            answers = []</td></tr><tr class="hit"><td class="line">79</td><td class="hits">3</td><td class="source">            success = false</td></tr><tr class="hit"><td class="line">80</td><td class="hits">3</td><td class="source">            reqErr  = undefined</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">3</td><td class="source">            reqErrFn = (code, msg...) =&gt;</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">                reqErr = new Error util.format msg...</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">                reqErr.code = code</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo('reqErrfn'), reqErr.message</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                @errCount += 1</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">3</td><td class="source">            req.on 'message', (err, answer) =&gt;</td></tr><tr class="hit"><td class="line">89</td><td class="hits">3</td><td class="source">                if err</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                    @log.error gLineInfo(&quot;should not have an error here!&quot;), {err:err?.message, answer:answer, q:q}</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">                    reqErrFn NAME_RCODE.SERVFAIL, &quot;msg err %j: %j&quot;, q, err.message ? err</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                else</td></tr><tr class="hit"><td class="line">93</td><td class="hits">3</td><td class="source">                    @log.debug gLineInfo(&quot;req-#{req.rsReqID} message&quot;), {resolved_q:q, to:answer.answer}</td></tr><tr class="hit"><td class="line">94</td><td class="hits">3</td><td class="source">                    if answer.answer.length &gt; 0</td></tr><tr class="hit"><td class="line">95</td><td class="hits">3</td><td class="source">                        try</td></tr><tr class="hit"><td class="line">96</td><td class="hits">3</td><td class="source">                            answers.push answer.answer...</td></tr><tr class="hit"><td class="line">97</td><td class="hits">3</td><td class="source">                            answer.answer.forEach (a) =&gt; @push @answerFilter a</td></tr><tr class="hit"><td class="line">98</td><td class="hits">3</td><td class="source">                            success = true</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                        catch e</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                            # See: https://github.com/okTurtles/dnschain/issues/43</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">                            @log.warn gLineInfo(&quot;couldn't push answer&quot;), {error: e.message, q:q, cname:cname, answer:answer}</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">                            reqErrFn NAME_RCODE.SERVFAIL, &quot;push after EOF for '%j'?: %j&quot;, cname, e.message</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    else</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">                        reqErrFn NAME_RCODE.NOTFOUND, &quot;cname not found: %j&quot;, cname</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">106</td><td class="hits">3</td><td class="source">            req.on 'timeout', =&gt;</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo(&quot;req-#{req.rsReqID} timeout&quot;), {q:q}</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                # TODO: better rcode value? am not aware of a timeout value</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                #       https://www.iana.org/assignments/dns-parameters/dns-parameters.xhtml</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">                reqErrFn NAME_RCODE.SERVFAIL, &quot;timeout for '%j': %j&quot;, cname, req</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">112</td><td class="hits">3</td><td class="source">            req.on 'cancelled', =&gt;</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">                @log.debug gLineInfo(&quot;req-#{req.rsReqID} cancelled&quot;), {q:q}</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                success = false</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">116</td><td class="hits">3</td><td class="source">            req.on 'error', (err) =&gt;</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">                @log.warn gLineInfo(&quot;req-#{req.rsReqID} error&quot;), {q:q, err:err?.message}</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                reqErrFn NAME_RCODE.SERVFAIL, &quot;error for '%j': %j&quot;, cname, err</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">3</td><td class="source">            req.on 'end', =&gt;</td></tr><tr class="hit"><td class="line">121</td><td class="hits">3</td><td class="source">                @log.debug gLineInfo(&quot;req-#{req.rsReqID} end&quot;), {q:q, answers:answers, success:success}</td></tr><tr class="hit"><td class="line">122</td><td class="hits">3</td><td class="source">                delete @requests[req.rsReqID]</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                # it is possible that neither 'success' is true</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                # nor is 'reqError' defined. This can happen</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                # when 'cancelRequests' is called on us.</td></tr><tr class="hit"><td class="line">126</td><td class="hits">3</td><td class="source">                if reqErr</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">                    @log.debug gLineInfo(&quot;req-#{req.rsReqID} failed&quot;), {err:reqErr.message, q:q}</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                    # we emit 'failed' instead of 'error' so that we can continue</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                    # processing other `cname`s in the pipeline.</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                    @emit 'failed', reqErr</td></tr><tr class="hit"><td class="line">131</td><td class="hits">3</td><td class="source">                else if success</td></tr><tr class="hit"><td class="line">132</td><td class="hits">3</td><td class="source">                    @emit 'answers', answers</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                # we always call `callback` without an error value for the same reason that</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                # that we emit 'failed' instead of 'error' (to continue processing)</td></tr><tr class="hit"><td class="line">136</td><td class="hits">3</td><td class="source">                callback()</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">138</td><td class="hits">3</td><td class="source">            @log.debug gLineInfo(&quot;scheduling req-#{req.rsReqID}&quot;), {q:q, cname:cname}</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">140</td><td class="hits">3</td><td class="source">            @scheduler.schedule =&gt;</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                # add it to the active requests when it's actually sent</td></tr><tr class="hit"><td class="line">142</td><td class="hits">3</td><td class="source">                @requests[req.rsReqID] = req</td></tr><tr class="hit"><td class="line">143</td><td class="hits">3</td><td class="source">                @log.debug gLineInfo(&quot;sending req-#{req.rsReqID}&quot;), {q:q}</td></tr><tr class="hit"><td class="line">144</td><td class="hits">3</td><td class="source">                req.send()</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="src/lib/stacked-scheduler.coffee">src/lib/stacked-scheduler.coffee</h2><div id="stats" class="high"><div class="percentage">84%</div><div class="sloc">19</div><div class="hits">16</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">dnschain</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">http://dnschain.net</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">Copyright (c) 2014 okTurtles Foundation</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">This Source Code Form is subject to the terms of the Mozilla Public</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">License, v. 2.0. If a copy of the MPL was not distributed with this</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">file, You can obtain one at http://mozilla.org/MPL/2.0/.</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">###</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"># TODO: go through 'TODO's!</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">module.exports = (dnschain) -&gt;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    # expose these into our namespace</td></tr><tr class="hit"><td class="line">18</td><td class="hits">30</td><td class="source">    for k of dnschain.globals</td></tr><tr class="hit"><td class="line">19</td><td class="hits">840</td><td class="source">        eval &quot;var #{k} = dnschain.globals.#{k};&quot;</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">30</td><td class="source">    class StackedScheduler</td></tr><tr class="hit"><td class="line">22</td><td class="hits">30</td><td class="source">        constructor: ({@stackedDelay}) -&gt;</td></tr><tr class="hit"><td class="line">23</td><td class="hits">2</td><td class="source">            @stackedDelay ?= 2000 # 2 seconds by default</td></tr><tr class="hit"><td class="line">24</td><td class="hits">2</td><td class="source">            @tasks = {}</td></tr><tr class="hit"><td class="line">25</td><td class="hits">2</td><td class="source">            @nextRunTime = Date.now()</td></tr><tr class="hit"><td class="line">26</td><td class="hits">2</td><td class="source">            @taskCounter = 0</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        cancelAll: (runCallback=false)-&gt;</td></tr><tr class="hit"><td class="line">29</td><td class="hits">2</td><td class="source">            for key, task of @tasks</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">                clearTimeout(task.tid)</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">                task.callback() if runCallback</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">                delete @tasks[key]</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        schedule: (callback) -&gt;</td></tr><tr class="hit"><td class="line">35</td><td class="hits">3</td><td class="source">            diffMillis = @nextRunTime - Date.now()</td></tr><tr class="hit"><td class="line">36</td><td class="hits">3</td><td class="source">            @nextRunTime += @stackedDelay - Math.min(diffMillis, 0)</td></tr><tr class="hit"><td class="line">37</td><td class="hits">3</td><td class="source">            nonce = @taskCounter++</td></tr><tr class="hit"><td class="line">38</td><td class="hits">3</td><td class="source">            @tasks[nonce] =</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                callback: callback # for 'cancelAll'</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                tid: setTimeout =&gt;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">3</td><td class="source">                    delete @tasks[nonce]</td></tr><tr class="hit"><td class="line">42</td><td class="hits">3</td><td class="source">                    callback()</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                , Math.max diffMillis, 0</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div></div></div>
<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setCookieDomain", "*.okturtles.com"]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u=(("https:" === document.location.protocol) ? "https" : "http") + "://piwik.okturtles.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
    g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="http://piwik.okturtles.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->
</body></html>